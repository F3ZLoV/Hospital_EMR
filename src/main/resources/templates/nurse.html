<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이비인후과 EMR - 간호사 메인화면</title>
    <link rel="stylesheet" th:href="@{/css/nurse_style.css}" />
    <style>
        /* 모달 기본 스타일 (필요시 nurse_style.css에서 별도 관리 가능) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
<!-- 헤더 영역 -->
<div class="header">
    <div class="left-section">
        <span class="greeting">반갑습니다. 홍길동 님</span>
        <button>오늘의 현황</button>
        <button>진료실</button>
    </div>
    <div class="center-section">
        <input id="topSearchBar" class="search-bar" type="text" placeholder="환자검색/이름/환자등록번호/생년월일/휴대폰번호">
    </div>
    <div class="right-section">
        <span class="time-info" id="timeInfo">00:00:00</span>
        <button class="chat-button" id="chatButton">&#128172;</button>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div class="container">
    <!-- 좌측 사이드바: 프로필 및 대기 환자 리스트 -->
    <div class="sidebar">
        <div class="profile-banner">
            <div class="profile-top">
                <img src="https://via.placeholder.com/40" alt="Profile Picture" class="profile-pic">
                <div class="profile-name">홍길동(간호사)</div>
            </div>
            <div class="profile-stats">
                <span class="status-label">대기</span>
                <span id="waitingCount" class="status-number">0명</span>
                <span class="status-separator">|</span>
                <span class="status-label">오늘 수납</span>
                <span id="collectionCount" class="status-number">0명</span>
            </div>
        </div>
        <div class="waiting-patient-list">
            <div class="list-header">
                <h3>접수 대기 환자 리스트</h3>
            </div>
            <div class="list-container">
                <ul id="patientList">
                </ul>
            </div>
        </div>
    </div>

    <!-- 중앙 메인 콘텐츠 -->
    <div class="main-content">
        <button id="openModalBtn" class="new-patient-btn">신규 환자 등록</button>
        <button id="openAppointmentListModalBtn" class="new-patient-btn">진료 예약 목록</button>
    </div>

    <!-- 우측 배너: 캘린더 영역 -->
    <div class="right-banner">
        <!-- 캘린더 영역 -->
        <div class="calendar-banner">
            <button id="prevMonthBtn" title="이전 달">&#9664;</button>
            <span id="calendarMonth">2025.03</span>
            <button id="nextMonthBtn" title="다음 달">&#9654;</button>
            <div class="today-date" id="todayDate">오늘: 2025.03.13</div>
        </div>
        <table class="month-view" id="calendarBody">
            <!-- 캘린더 헤더와 날짜 버튼들이 렌더링됨 -->
        </table>
        <!-- 하단 일정 목록 -->
        <div id="monthEventList">
            <h3>이번 달 일정</h3>
            <ul id="eventList"></ul>
        </div>

        <!-- 일정 추가/수정 모달 -->
        <div id="calendarEventModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeCalendarEventModal">&times;</span>
                <h3 id="calendarEventModalTitle">일정 추가</h3>
                <p id="selectedDateDisplay" style="font-weight: bold;"></p>
                <form id="calendarEventForm">
                    <label for="eventTitleInput">제목:</label>
                    <input type="text" id="eventTitleInput" name="eventTitle" required>
                    <br>
                    <label for="eventDescInput">설명:</label>
                    <input type="text" id="eventDescInput" name="eventDesc">
                    <br>
                    <button type="submit">저장</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 모달 창 영역 -->

<!-- 신규 환자 등록 모달 (HTML 일부) -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closePatientModal">&times;</span>
        <h3>신규 환자 등록</h3>
        <!-- 여기서 formMessage 영역을 사용 -->
        <div id="formMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="patientForm" th:action="@{/patient}" method="post">
            <!-- 폼 내용 -->
            <table>
                <tr>
                    <td><label for="name">이름:</label></td>
                    <td><input type="text" id="name" name="name" required></td>
                    <td><label for="date_of_birth">생년월일:</label></td>
                    <td><input type="date" id="date_of_birth" name="date_of_birth" required></td>
                </tr>
                <tr>
                    <td><label for="gender">성별:</label></td>
                    <td>
                        <select id="gender" name="gender" required>
                            <option value="">선택</option>
                            <option value="남">남</option>
                            <option value="여">여</option>
                        </select>
                    </td>
                    <td><label for="phone_number">전화번호:</label></td>
                    <td><input type="text" id="phone_number" name="phone_number" required></td>
                </tr>
                <tr>
                    <td><label for="email">이메일:</label></td>
                    <td><input type="email" id="email" name="email" required></td>
                    <td><label for="address">주소:</label></td>
                    <td><input type="text" id="address" name="address" required></td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: center; padding-top:10px;">
                        <button type="submit">등록</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>


<!-- 환자 검색 결과 모달 -->
<div id="searchResultModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeSearchModal">&times;</span>
        <h3>검색 결과</h3>
        <div id="searchResultContainer"></div>
    </div>
</div>

<!-- 대기 리스트 삭제(호출 취소) 확인 모달 -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" id="closeConfirmModal">&times;</span>
        <h3>삭제 확인</h3>
        <p>해당 환자를 대기 리스트에서 제거하시겠습니까?</p>
        <button id="confirmYesBtn">&nbsp;&nbsp;&nbsp;예&nbsp;&nbsp;&nbsp;</button>
        <button id="confirmNoBtn">아니오</button>
    </div>
</div>

<!-- 진료 예약 모달 -->
<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentModal">&times;</span>
        <h3>진료 예약</h3>
        <div id="appointmentFormMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="appointmentForm" th:action="@{/appointment}" method="post">
            <table>
                <tr>
                    <td><label for="patient_id">환자 ID:</label></td>
                    <td><input type="number" id="patient_id" name="patient_id" required></td>
                </tr>
                <tr>
                    <td><label for="staff_id">의료진 ID:</label></td>
                    <td><input type="number" id="staff_id" name="staff_id" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_date">예약 날짜:</label></td>
                    <td><input type="date" id="appointment_date" name="appointment_date" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_time">예약 시간:</label></td>
                    <td><input type="time" id="appointment_time" name="appointment_time" required></td>
                </tr>
                <tr>
                    <td><input type="hidden" id="status" name="status" value="예약"></td>
                </tr>
                <tr>
                    <td><label for="remarks">메모:</label></td>
                    <td><input type="text" id="remarks" name="remarks" required></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: center; padding-top:10px;">
                        <button type="submit">예약 등록</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<!-- 예약 목록 모달 -->
<div id="appointmentListModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentListModal">&times;</span>
        <h3>진료 예약 목록</h3>
        <div id="appointmentListContainer"></div>
    </div>
</div>

<!-- 호출 모달 (간호사 페이지에서 호출 이벤트 발생 시 바로 띄움) -->
<div id="callModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeCallModal">&times;</span>
        <h3>호출된 환자 정보</h3>
        <div id="callPatientInfo">
            <!-- AJAX로 호출 환자 정보를 로드 -->
        </div>
        <button id="confirmCallBtn">확인</button>
        <button id="holdCallBtn">보류</button>
    </div>
</div>

<!-- 접수 모달 -->
<div id="receptionModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeReceptionModal">&times;</span>
        <h3>진료 접수</h3>

        <form id="receptionForm" action="/patient/register" method="post">
            <!-- 숨겨진/읽기전용 환자 ID -->
            <label for="patientId">환자 ID:</label>
            <input type="text" id="patientId" name="patientId" readonly />

            <!-- 의사 ID (직접 입력) -->
            <label for="doctorId">의사 ID:</label>
            <input type="number" id="doctorId" name="doctorId" />

            <!-- 진료 날짜/시간 -->
            <label for="visitDate">진료 날짜:</label>
            <input type="date" id="visitDate" name="visitDate" />
            <label for="visitTime">진료 시간:</label>
            <input type="time" id="visitTime" name="visitTime" />

            <!-- 진료 사유 -->
            <label for="visitReason">진료 사유:</label>
            <textarea id="visitReason" name="visitReason"></textarea>

            <!-- 방문 유형 -->
            <label for="visitType">방문 유형:</label>
            <select id="visitType" name="visitType">
                <option value="검진">검진</option>
                <option value="상담">상담</option>
                <option value="외래">외래</option>
                <option value="입원">입원</option>
                <option value="응급">응급</option>
                <option value="재진">재진</option>
                <option value="진료예약">진료예약</option>
                <option value="기타">기타</option>
            </select>

            <br><br>
            <button type="submit">접수 등록</button>
        </form>
        <div id="receptionFormMessage" style="margin-top: 10px; text-align: center;"></div>
    </div>
</div>

<!-- 스크립트 영역 -->
<script>
    // ----------------------
    // 기본 시간 및 채팅 기능
    // ----------------------
    function updateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
        const dayOfWeek = dayNames[now.getDay()];
        let hour = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = hour < 12 ? "오전" : "오후";
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour;
        const hourStr = String(hour).padStart(2, '0');
        document.getElementById("timeInfo").textContent = `${year}.${month}.${date} ${dayOfWeek} ${ampm} ${hourStr}:${minutes}:${seconds}`;
    }
    setInterval(updateTime, 1000);
    document.getElementById("chatButton").addEventListener("click", function(){
        alert("채팅 기능은 추후 구현 예정입니다!");
    });

    // ----------------------
    // 대기 환자 리스트 새로고침
    // ----------------------
    function refreshWaitingList() {
        fetch('/patient/waiting')
            .then(response => response.text())
            .then(html => { document.getElementById("patientList").innerHTML = html; })
            .catch(error => console.error("대기 리스트 오류:", error));
    }
    refreshWaitingList();
    setInterval(refreshWaitingList, 5000);

    // ----------------------
    // 정렬 기능
    // ----------------------
    function sortList() {
        const select = document.getElementById('sortSelect');
        const order = select.value;
        const list = document.getElementById('patientList');
        let items = Array.from(list.getElementsByTagName('li'));
        items.sort((a, b) => {
            return order === 'asc' ?
                a.textContent.trim().localeCompare(b.textContent.trim(), 'ko')
                : b.textContent.trim().localeCompare(a.textContent.trim(), 'ko');
        });
        list.innerHTML = "";
        items.forEach(item => list.appendChild(item));
    }

    // ----------------------
    // 캘린더 기능
    // ----------------------
    let currentDate = new Date();
    currentDate.setDate(1);
    function updateCalendarBanner() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthStr = String(month + 1).padStart(2, '0');
        document.getElementById("calendarMonth").textContent = `${year}.${monthStr}`;
        const today = new Date();
        const tYear = today.getFullYear();
        const tMonth = String(today.getMonth() + 1).padStart(2, '0');
        const tDate = String(today.getDate()).padStart(2, '0');
        document.getElementById("todayDate").textContent = `오늘: ${tYear}.${tMonth}.${tDate}`;
    }
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = "";
        let row = document.createElement("tr");
        let cellCount = 0;
        for(let i=0; i<firstDay; i++){
            let cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        for(let d=1; d<=lastDate; d++){
            let cell = document.createElement("td");
            cell.innerHTML = `<button class="day-btn">${d}</button>`;
            row.appendChild(cell);
            cellCount++;
            if(cellCount % 7 === 0){
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }
        while(cellCount % 7 !== 0){
            let cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        calendarBody.appendChild(row);
    }
    document.getElementById("prevMonthBtn").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth()-1);
        updateCalendarBanner();
        renderCalendar();
    });
    document.getElementById("nextMonthBtn").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth()+1);
        updateCalendarBanner();
        renderCalendar();
    });
    updateCalendarBanner();
    renderCalendar();

    // ----------------------
    // 접수 기능
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('register-btn')) {
            const patientId = e.target.getAttribute('data-id');
            // AJAX POST 요청: 환자 접수 처리
            fetch('/patient/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'patientId=' + encodeURIComponent(patientId)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // alert로 응답 메시지 표시
                    alert(data.message);
                    // 성공 시에만 모달 닫고 대기 리스트 갱신
                    if(data.success) {
                        document.getElementById("searchResultModal").style.display = "none";
                        refreshWaitingList();
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("환자 접수 중 오류 발생");
                });
        }
    });
    // 전역 변수에 삭제할 환자 ID 저장
    let deletePatientId = null;
    // 삭제 버튼 클릭 이벤트 처리 (대기 리스트 내)
    document.getElementById('patientList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
            deletePatientId = e.target.getAttribute('data-id');
            // 확인 모달 열기
            document.getElementById("confirmModal").style.display = "block";
        }
    });
    // 확인 모달 닫기 처리
    document.getElementById("closeConfirmModal").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
    };

    // "아니오" 버튼 처리
    document.getElementById("confirmNoBtn").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
        deletePatientId = null;
    };

    // "예" 버튼 처리: 실제로 환자 삭제 (대기 리스트에서 제거)
    document.getElementById("confirmYesBtn").onclick = function() {
        if (deletePatientId) {
            fetch('/patient/waiting/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'patientId=' + encodeURIComponent(deletePatientId)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    if(data.success) {
                        alert("대기 리스트에서 제거되었습니다.");
                        refreshWaitingList();
                    } else {
                        alert("대기 리스트에서 제거에 실패했습니다.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("대기 리스트에서 제거 중 오류 발생");
                })
                .finally(() => {
                    // 확인 모달 닫기 및 변수 초기화
                    document.getElementById("confirmModal").style.display = "none";
                    deletePatientId = null;
                });
        }
    };

    setInterval(() => {
        refreshWaitingList();
    }, 5000); // 5초

    function refreshStats() {
        fetch('/patient/stats')
            .then(response => {
                if (!response.ok) throw new Error("네트워크 응답 오류");
                return response.json();
            })
            .then(data => {
                document.getElementById('waitingCount').innerText = data.waitingCount + "명";
                document.getElementById('collectionCount').innerText = data.collectionCount + "명";
            })
            .catch(error => {
                console.error("Stats refresh error:", error);
            });
    }

    // 페이지 로드 시 및 5초 간격으로 업데이트
    refreshStats();
    setInterval(refreshStats, 5000);


    // ----------------------
    // 호출 모달 기능 (간호사 페이지)
    // ----------------------
    window.addEventListener("storage", function(event) {
        if (event.key === "callPatient" && event.newValue) {
            try {
                const callInfo = JSON.parse(event.newValue);
                const patientId = callInfo.patientId;
                if (!patientId) return;
                fetch('/patient/call?patientId=' + encodeURIComponent(patientId))
                    .then(response => response.json())
                    .then(patient => {
                        document.getElementById("callPatientInfo").innerHTML = `
            <p><strong>이름:</strong> ${patient.name}</p>
            <p><strong>생년월일:</strong> ${patient.date_of_birth}</p>
            <p><strong>전화번호:</strong> ${patient.phone_number}</p>
            <p><strong>이메일:</strong> ${patient.email}</p>
            <p><strong>주소:</strong> ${patient.address}</p>
          `;
                        document.getElementById("callModal").dataset.patientId = patientId;
                        document.getElementById("callModal").style.display = "block";
                    })
                    .catch(error => console.error("호출 환자 정보 로드 실패:", error));
            } catch(e) {
                console.error("호출 이벤트 파싱 오류:", e);
            }
        }
    });
    document.getElementById("closeCallModal").onclick = function() {
        document.getElementById("callModal").style.display = "none";
    };

    // 호출 모달 "확인" 버튼 (nurse 페이지)
    document.getElementById("confirmCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        // 백엔드에서 환자의 상태를 '진료중' (called = true)로 업데이트하도록 함
        fetch('/patient/call/confirm', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                // 대기 리스트는 즉시 제거하지 않고, 나중에 의사 페이지에서 버튼 상태에 따라 업데이트됨
                // (예: 주기적 새로고침 시 환자의 called 플래그가 true로 반영됨)
            })
            .catch(error => {
                console.error("호출 확인 실패:", error);
                alert("호출 확인에 실패하였습니다.");
            });
    });

    // 호출 모달 "보류" 버튼 처리
    document.getElementById("holdCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        fetch('/patient/call/hold', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                refreshWaitingList();
            })
            .catch(error => {
                console.error("보류 처리 실패:", error);
                alert("보류 처리에 실패하였습니다.");
            });
    });

    // ----------------------
    // 환자 검색 결과 모달 처리
    // ----------------------
    const searchBar = document.getElementById("topSearchBar");
    searchBar.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const keyword = searchBar.value.trim();
            if (!keyword) {
                alert("검색어를 입력하세요.");
                return;
            }
            fetch(`/patient/search?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("searchResultContainer").innerHTML = html;
                    document.getElementById("searchResultModal").style.display = "block";
                })
                .catch(error => {
                    console.error("검색 실패:", error);
                    alert("검색 결과를 불러오는데 실패했습니다.");
                });
        }
    });
    const searchResultModal = document.getElementById("searchResultModal");
    const closeSearchModal = document.getElementById("closeSearchModal");
    closeSearchModal.onclick = function() {
        searchResultModal.style.display = "none";
    };
    window.onclick = function(event) {
        if (event.target === searchResultModal) {
            searchResultModal.style.display = "none";
        }
    };

    // ----------------------
    // 예약 모달 처리
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('appointment-btn')) {
            const patientId = e.target.getAttribute('data-id');
            if (!patientId) {
                alert("환자 ID가 누락되었습니다.");
                return;
            }
            document.getElementById('patient_id').value = patientId;
            document.getElementById('appointmentModal').style.display = "block";
        }
    });
    const appointmentModal = document.getElementById("appointmentModal");
    const closeAppointmentModalBtn = document.getElementById("closeAppointmentModal");
    closeAppointmentModalBtn.onclick = function() {
        appointmentModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentModal) {
            appointmentModal.style.display = "none";
        }
    });
    const appointmentForm = document.getElementById("appointmentForm");
    const appointmentFormMessage = document.getElementById("appointmentFormMessage");
    appointmentForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(appointmentForm);
        fetch(appointmentForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("네트워크 오류");
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    appointmentFormMessage.style.color = "green";
                    appointmentFormMessage.textContent = data.message;
                    setTimeout(() => {
                        appointmentModal.style.display = "none";
                        appointmentForm.reset();
                        appointmentFormMessage.textContent = "";
                    }, 1500);
                } else {
                    appointmentFormMessage.style.color = "red";
                    appointmentFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("예약 등록 중 오류:", error);
                appointmentFormMessage.style.color = "red";
                appointmentFormMessage.textContent = "예약 등록에 실패하였습니다.";
            });
    });

    // 예약 목록 모달 처리
    const openAppointmentListModalBtn = document.getElementById("openAppointmentListModalBtn");
    const appointmentListModal = document.getElementById("appointmentListModal");
    const closeAppointmentListModalBtn = document.getElementById("closeAppointmentListModal");
    openAppointmentListModalBtn.onclick = function() {
        fetch('/appointment/list')
            .then(response => {
                if (!response.ok) throw new Error("네트워크 응답 오류");
                return response.text();
            })
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
                appointmentListModal.style.display = "block";
            })
            .catch(error => {
                console.error("예약 목록 불러오기 실패:", error);
                alert("예약 목록을 불러오는데 실패했습니다.");
            });
    };
    closeAppointmentListModalBtn.onclick = function() {
        appointmentListModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentListModal) {
            appointmentListModal.style.display = "none";
        }
    });

    // ----------------------
    // 캘린더 이벤트 (일정 추가) – 클라이언트 사이드 처리
    // ----------------------
    (function(){
        let events = {}; // { "YYYY-MM-DD": [{ title: "회의", desc: "내용" }, ...] }
        function renderEventCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month+1, 0).getDate();
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = "";
            let row = document.createElement('tr');
            let cellCount = 0;
            for(let i=0; i<firstDay; i++){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            for(let d=1; d<=lastDate; d++){
                let cell = document.createElement('td');
                let btn = document.createElement('button');
                btn.className = 'day-btn';
                btn.textContent = d;
                let dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(events[dateKey] && events[dateKey].length > 0){
                    btn.classList.add('has-event');
                }
                btn.addEventListener('click', function(){
                    openEventModal(dateKey);
                });
                cell.appendChild(btn);
                row.appendChild(cell);
                cellCount++;
                if(cellCount % 7 === 0){
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                }
            }
            while(cellCount % 7 !== 0){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            calendarBody.appendChild(row);
        }
        function refreshEventList() {
            const eventListElem = document.getElementById("eventList");
            eventListElem.innerHTML = "";
            const currentMonthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}`;
            for(let dateKey in events){
                if(dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0){
                    let li = document.createElement('li');
                    li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                    eventListElem.appendChild(li);
                }
            }
        }
        const eventModal = document.getElementById("eventModal");
        const closeEventModalBtn = document.getElementById("closeEventModal");
        const modalDateDisplay = document.getElementById("modalDateDisplay");
        let selectedDateKey = "";
        function openEventModal(dateKey) {
            selectedDateKey = dateKey;
            modalDateDisplay.textContent = "날짜: " + dateKey;
            eventModal.style.display = "block";
        }
        closeEventModalBtn.onclick = function(){
            eventModal.style.display = "none";
        };
        window.addEventListener('click', function(event){
            if(event.target === eventModal){
                eventModal.style.display = "none";
            }
        });
        document.getElementById("eventForm").addEventListener("submit", function(e){
            e.preventDefault();
            const title = document.getElementById("eventTitle").value.trim();
            const desc = document.getElementById("eventDesc").value.trim();
            if(!title){
                alert("제목을 입력하세요.");
                return;
            }
            if(!events[selectedDateKey]){
                events[selectedDateKey] = [];
            }
            events[selectedDateKey].push({ title: title, desc: desc });
            eventModal.style.display = "none";
            document.getElementById("eventForm").reset();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()-1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()+1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        updateCalendarBanner();
        renderEventCalendar();
        refreshEventList();
    })();

</script>
<!-- 접수 모달 처리 -->
<script>
    function openReceptionModal(patientId) {
        document.getElementById("patientId").value = patientId;
        let now = new Date();
        document.getElementById("visitDate").valueAsDate = now;
        let hh = String(now.getHours()).padStart(2, '0');
        let mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById("visitTime").value = hh + ":" + mm;
        document.getElementById("receptionModal").style.display = "block";
    }

    document.getElementById("closeReceptionModal").onclick = function() {
        document.getElementById("receptionModal").style.display = "none";
    };

    const receptionForm = document.getElementById("receptionForm");
    const receptionFormMessage = document.getElementById("receptionFormMessage");
    receptionForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(receptionForm);

        fetch(receptionForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    receptionFormMessage.style.color = "green";
                    receptionFormMessage.textContent = data.message;
                    setTimeout(() => {
                        document.getElementById("receptionModal").style.display = "none";
                        receptionForm.reset();
                        receptionFormMessage.textContent = "";
                        refreshWaitingList();
                    }, 1000);
                } else {
                    receptionFormMessage.style.color = "red";
                    receptionFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("접수 등록 실패:", error);
                receptionFormMessage.style.color = "red";
                receptionFormMessage.textContent = "등록 중 오류 발생";
            });
    });

    // 접수 모달에서 폼 제출 시 처리
    document.getElementById("receptionForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(document.getElementById("receptionForm"));

        // 먼저 /patient/register API 호출 (환자 대기 상태 업데이트)
        fetch('/patient/register', {
            method: "POST",
            body: new URLSearchParams({ patientId: formData.get("patientId") })
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // 환자 접수가 성공하면, 진료 접수 정보를 등록하기 위해 /medicalvisit/create 호출
                    return fetch('/medicalvisit/create', {
                        method: "POST",
                        body: new URLSearchParams({
                            patientId: formData.get("patientId"),
                            doctorId: formData.get("doctorId"),
                            visitDate: formData.get("visitDate"),
                            visitTime: formData.get("visitTime"),
                            visitReason: formData.get("visitReason"),
                            visitType: formData.get("visitType")
                        })
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert("진료 접수 등록 성공");
                    document.getElementById("receptionModal").style.display = "none";
                    // 필요시 대기 리스트 새로고침 등 추가 작업
                } else {
                    alert("진료 접수 등록 실패: " + data.message);
                }
            })
            .catch(error => {
                console.error("접수 처리 중 오류:", error);
                alert("접수 처리 중 오류가 발생하였습니다.");
            });
    });
</script>
<script>
    document.getElementById("openModalBtn").addEventListener("click", function() {
        document.getElementById("patientModal").style.display = "block";
    });
    document.getElementById("closePatientModal").onclick = function() {
        document.getElementById("patientModal").style.display = "none";
    };
    document.getElementById("patientForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                const formMessage = document.getElementById("formMessage");
                if (data.success) {
                    formMessage.style.color = "green";
                    formMessage.textContent = data.message;
                    // 1.5초 후에 모달창 닫고 폼 리셋
                    setTimeout(() => {
                        document.getElementById("patientModal").style.display = "none";
                        form.reset();
                        formMessage.textContent = "";
                    }, 1500);
                } else {
                    formMessage.style.color = "red";
                    formMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("환자 등록 중 오류 발생:", error);
                const formMessage = document.getElementById("formMessage");
                formMessage.style.color = "red";
                formMessage.textContent = "환자 등록 중 오류 발생";
            });
    });
</script>

<script>
    var calendarRole = "nurse";

    // 캘린더 렌더링 함수 (날짜 버튼에 data-date 속성 부여)
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = "";
        let row = document.createElement("tr");
        let cellCount = 0;
        for(let i = 0; i < firstDay; i++){
            let cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        for(let d = 1; d <= lastDate; d++){
            let cell = document.createElement("td");
            let btn = document.createElement("button");
            btn.className = 'day-btn';
            btn.textContent = d;
            let fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            btn.setAttribute("data-date", fullDate);
            // 오늘 날짜 하이라이트
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                btn.classList.add("today");
            }
            btn.addEventListener('click', function() {
                openCalendarEventModal(fullDate, calendarRole);
            });
            cell.appendChild(btn);
            row.appendChild(cell);
            cellCount++;
            if(cellCount % 7 === 0){
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }
        while(cellCount % 7 !== 0){
            let cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        calendarBody.appendChild(row);
    }

    // 모달 열기: 선택한 날짜와 해당 역할의 일정 조회 후 모달에 세팅
    function openCalendarEventModal(dateStr, role) {
        document.getElementById('selectedDateDisplay').textContent = dateStr;
        document.getElementById('eventTitleInput').value = "";
        document.getElementById('eventDescInput').value = "";
        document.getElementById('calendarEventModalTitle').textContent = "일정 추가";

        fetch('/calendar/' + role + '/events?year=' + dateStr.split('-')[0] + '&month=' + dateStr.split('-')[1])
            .then(response => response.json())
            .then(events => {
                let event = events.find(e => e.eventDate === dateStr);
                if (event) {
                    document.getElementById('eventTitleInput').value = event.title;
                    document.getElementById('eventDescInput').value = event.description;
                    document.getElementById('calendarEventModalTitle').textContent = "일정 수정";
                }
                document.getElementById("calendarEventModal").style.display = "block";
            })
            .catch(error => {
                console.error("이벤트 조회 오류:", error);
                document.getElementById("calendarEventModal").style.display = "block";
            });
    }

    // 모달 닫기
    document.getElementById("closeCalendarEventModal").onclick = function() {
        document.getElementById("calendarEventModal").style.display = "none";
    };

    // 일정 저장 (생성 또는 수정)
    document.getElementById("calendarEventForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const dateStr = document.getElementById("selectedDateDisplay").textContent;
        const title = document.getElementById("eventTitleInput").value;
        const desc = document.getElementById("eventDescInput").value;
        fetch('/calendar/' + calendarRole + '/save', {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: "eventDate=" + encodeURIComponent(dateStr) +
                "&title=" + encodeURIComponent(title) +
                "&description=" + encodeURIComponent(desc)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("calendarEventModal").style.display = "none";
                refreshMonthlyEventList();
            })
            .catch(error => {
                console.error("일정 저장 오류:", error);
                alert("일정 저장 중 오류 발생");
            });
    });

    // 월간 일정 리스트 갱신 (현재 달의 이벤트를 리스트로 출력)
    function refreshMonthlyEventList() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // 1~12
        fetch('/calendar/' + calendarRole + '/events?year=' + year + '&month=' + month)
            .then(response => response.json())
            .then(events => {
                const listElem = document.getElementById("eventList");
                listElem.innerHTML = "";
                events.forEach(event => {
                    let li = document.createElement("li");
                    li.textContent = event.eventDate + " : " + event.title;
                    listElem.appendChild(li);
                });
            })
            .catch(error => {
                console.error("월간 일정 조회 오류:", error);
            });
    }

    // 호출, 캘린더 초기화, 등 기존의 캘린더 스크립트 호출
    updateCalendarBanner();
    renderCalendar();
    refreshMonthlyEventList();

</script>
<script>
    // 예약 목록에 있는 "접수" 및 "취소" 버튼 클릭 이벤트 처리
    document.addEventListener("click", function(e) {
        // "접수" 버튼 클릭 시
        if (e.target && e.target.classList.contains("reception-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            var patientId = e.target.getAttribute("data-patient-id");
            if (!appointmentId || !patientId) return;
            if (confirm("이 예약을 접수 처리하시겠습니까? (상태가 '완료'로 업데이트되고 환자 대기 리스트로 등록됩니다)")) {
                // 첫 번째: 예약 상태를 '완료'로 업데이트
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=완료`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 두 번째: patient 테이블의 waiting 값을 true로 업데이트 (/patient/register 엔드포인트 활용)
                            return fetch(`/patient/register?patientId=${patientId}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" }
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .then(response => response.json())
                    .then(function(data2) {
                        alert("접수 처리 완료: " + data2.message);
                        // 예약 목록 및 대기 환자 리스트 갱신
                        refreshAppointmentList();
                        refreshWaitingList();  // 이 함수는 대기 환자 리스트를 새로고침하는 함수를 구현해야 합니다.
                    })
                    .catch(function(error) {
                        console.error("접수 처리 오류:", error);
                        alert("예약 접수 및 대기 등록 처리 중 오류가 발생하였습니다.");
                    });
            }
        }
        // "취소" 버튼 클릭 시
        else if (e.target && e.target.classList.contains("cancel-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            if (confirm("이 예약을 취소하시겠습니까?")) {
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=취소`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(function(data) {
                        alert(data.message);
                        refreshAppointmentList();
                    })
                    .catch(function(error) {
                        console.error("취소 처리 오류:", error);
                        alert("예약 취소 처리 중 오류가 발생하였습니다.");
                    });
            }
        }
    });

    // 예약 목록을 새로고침하는 함수 (AJAX로 예약 목록 fragment 재로딩)
    function refreshAppointmentList() {
        fetch('/appointment/list')
            .then(response => response.text())
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
            })
            .catch(function(error) {
                console.error("예약 목록 갱신 오류:", error);
            });
    }

    // 예시: 대기 환자 리스트를 새로고침하는 함수 (별도로 구현)
    function refreshWaitingList() {
        fetch('/patient/doctor/waiting')
            .then(response => response.text())
            .then(html => {
                document.getElementById("doctorPatientList").innerHTML = html;
            })
            .catch(function(error) {
                console.error("대기 리스트 갱신 오류:", error);
            });
    }

</script>
</body>
</html>