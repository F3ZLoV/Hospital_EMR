<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì´ë¹„ì¸í›„ê³¼ EMR - ê°„í˜¸ì‚¬ ë©”ì¸í™”ë©´</title>
    <link rel="stylesheet" th:href="@{/css/nurse_style.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ëª¨ë‹¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<!-- í—¤ë” ì˜ì—­ -->
<div class="header">
    <div class="left-section">
        <span class="greeting">ë°˜ê°‘ìŠµë‹ˆë‹¤. í™ê¸¸ë™ ë‹˜</span>
        <button>ì˜¤ëŠ˜ì˜ í˜„í™©</button>
        <button>ì§„ë£Œì‹¤</button>
    </div>
    <div class="center-section">
        <input id="topSearchBar" class="search-bar" type="text" placeholder="í™˜ìê²€ìƒ‰/ì´ë¦„/í™˜ìë“±ë¡ë²ˆí˜¸/ìƒë…„ì›”ì¼/íœ´ëŒ€í°ë²ˆí˜¸">
    </div>
    <div class="right-section">
        <span class="time-info" id="timeInfo">00:00:00</span>
        <button class="chat-button" id="chatButton">&#128172;</button>
    </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container">
    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°”: í”„ë¡œí•„ ë° ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸ -->
    <div class="sidebar">
        <div class="profile-banner">
            <div class="profile-top">
                <img src="https://via.placeholder.com/40" alt="Profile Picture" class="profile-pic">
                <div class="profile-name">í™ê¸¸ë™(ê°„í˜¸ì‚¬)</div>
            </div>
            <div class="profile-stats">
                <span class="status-label">ëŒ€ê¸°</span>
                <span id="waitingCount" class="status-number">0ëª…</span>
                <span class="status-separator">|</span>
                <span class="status-label">ì˜¤ëŠ˜ ìˆ˜ë‚©</span>
                <span id="collectionCount" class="status-number">0ëª…</span>
            </div>
        </div>
        <div class="waiting-patient-list">
            <div class="list-header">
                <h3>ì ‘ìˆ˜ ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸</h3>
            </div>
            <div class="list-container">
                <ul id="patientList">
                </ul>
            </div>
        </div>
    </div>

    <!-- ì¤‘ì•™ ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <div class="feature-btn-grid">
            <button class="new-patient-btn" id="openModalBtn">
                <span class="icon">ğŸ“</span>
                <span>ì‹ ê·œ í™˜ì ë“±ë¡</span>
            </button>
            <button class="new-patient-btn" id="openAppointmentListModalBtn">
                <span class="icon">ğŸ“…</span>
                <span>ì§„ë£Œ ì˜ˆì•½ ëª©ë¡</span>
            </button>
            <button class="new-patient-btn" id="openPrescriptionModalBtn">
                <span class="icon">ğŸ’Š</span>
                <span>ì²˜ë°©ì „ ì¶œë ¥</span>
            </button>
            <button id="openStatsModalBtn">
                <span class="icon">ğŸ“Š</span>
                <span>í†µê³„ ë³´ê¸°</span>
            </button>
        </div>
    </div>

    <!-- ìš°ì¸¡ ë°°ë„ˆ: ìº˜ë¦°ë” ì˜ì—­ -->
    <div class="right-banner">
        <div class="calendar-banner">
            <button id="prevMonthBtn" title="ì´ì „ ë‹¬">&#9664;</button>
            <span id="calendarMonth">2025.03</span>
            <button id="nextMonthBtn" title="ë‹¤ìŒ ë‹¬">&#9654;</button>
            <div class="today-date" id="todayDate">ì˜¤ëŠ˜: 2025.03.13</div>
        </div>
        <table class="month-view" id="calendarTable">
            <thead>
            <tr>
                <th>ì¼</th>
                <th>ì›”</th>
                <th>í™”</th>
                <th>ìˆ˜</th>
                <th>ëª©</th>
                <th>ê¸ˆ</th>
                <th>í† </th>
            </tr>
            </thead>
            <tbody id="calendarBody">
            <!-- ë‚ ì§œ ë²„íŠ¼ì´ JavaScriptë¡œ ìƒì„±ë¨ -->
            </tbody>
        </table>
        <div id="monthEventList">
            <h3>ì´ë²ˆ ë‹¬ ì¼ì •</h3>
            <ul id="eventList" style="list-style: none; padding: 0;"></ul>
        </div>

        <!-- ì¼ì • ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="calendarEventModal" class="modal" style="display:none;">
            <div class="modal-content" style="background:#fff; padding:20px; border-radius:4px; width:300px; margin:100px auto; position:relative;">
                <span class="close" id="closeCalendarEventModal" style="position:absolute; top:8px; right:12px; cursor:pointer;">&times;</span>
                <h3 id="calendarEventModalTitle">ì¼ì • ê´€ë¦¬</h3>
                <!-- ì„ íƒí•œ ë‚ ì§œ í‘œì‹œ -->
                <p id="selectedDateDisplay" style="font-weight: bold;"></p>
                <!-- ê¸°ì¡´ ì¼ì • ëª©ë¡ -->
                <div id="existingEvents" style="max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px; font-size:0.9rem;">
                    <em style="color:#999;">í•´ë‹¹ ë‚ ì§œì— ë“±ë¡ëœ ì¼ì • ì—†ìŒ</em>
                </div>
                <!-- ìˆ¨ì€ eventId ì…ë ¥ -->
                <input type="hidden" id="eventIdInput" name="eventId" value="">
                <!-- ìƒˆ ì¼ì •/ìˆ˜ì • í¼ -->
                <form id="calendarEventForm">
                    <div>
                        <label for="eventTitleInput">ì œëª©:</label><br>
                        <input type="text" id="eventTitleInput" name="eventTitle" required style="width:100%; box-sizing:border-box;">
                    </div>
                    <div style="margin-top:8px;">
                        <label for="eventDescInput">ë‚´ìš©:</label><br>
                        <textarea id="eventDescInput" name="eventDesc" style="width:100%; box-sizing:border-box;"></textarea>
                    </div>
                    <div style="margin-top:12px; text-align:right;">
                        <button type="submit">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ ì°½ ì˜ì—­ -->

<!-- ì‹ ê·œ í™˜ì ë“±ë¡ ëª¨ë‹¬ (HTML ì¼ë¶€) -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closePatientModal">&times;</span>
        <h3>ì‹ ê·œ í™˜ì ë“±ë¡</h3>
        <!-- ì—¬ê¸°ì„œ formMessage ì˜ì—­ì„ ì‚¬ìš© -->
        <div id="formMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="patientForm" th:action="@{/patient}" method="post">
            <!-- í¼ ë‚´ìš© -->
            <table>
                <tr>
                    <td><label for="name">ì´ë¦„:</label></td>
                    <td><input type="text" id="name" name="name" required></td>
                    <td><label for="date_of_birth">ìƒë…„ì›”ì¼:</label></td>
                    <td><input type="date" id="date_of_birth" name="date_of_birth" required></td>
                </tr>
                <tr>
                    <td><label for="gender">ì„±ë³„:</label></td>
                    <td>
                        <select id="gender" name="gender" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ë‚¨">ë‚¨</option>
                            <option value="ì—¬">ì—¬</option>
                        </select>
                    </td>
                    <td><label for="phone_number">ì „í™”ë²ˆí˜¸:</label></td>
                    <td><input type="text" id="phone_number" name="phone_number" required></td>
                </tr>
                <tr>
                    <td><label for="email">ì´ë©”ì¼:</label></td>
                    <td><input type="email" id="email" name="email" required></td>
                    <td><label for="address">ì£¼ì†Œ:</label></td>
                    <td><input type="text" id="address" name="address" required></td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: center; padding-top:10px;">
                        <button type="submit">ë“±ë¡</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>


<!-- í™˜ì ê²€ìƒ‰ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="searchResultModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeSearchModal">&times;</span>
        <h3>ê²€ìƒ‰ ê²°ê³¼</h3>
        <div id="searchResultContainer"></div>
    </div>
</div>

<!-- ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ì‚­ì œ(í˜¸ì¶œ ì·¨ì†Œ) í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" id="closeConfirmModal">&times;</span>
        <h3>ì‚­ì œ í™•ì¸</h3>
        <p>í•´ë‹¹ í™˜ìë¥¼ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <button id="confirmYesBtn">&nbsp;&nbsp;&nbsp;ì˜ˆ&nbsp;&nbsp;&nbsp;</button>
        <button id="confirmNoBtn">ì•„ë‹ˆì˜¤</button>
    </div>
</div>

<!-- ì§„ë£Œ ì˜ˆì•½ ëª¨ë‹¬ -->
<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentModal">&times;</span>
        <h3>ì§„ë£Œ ì˜ˆì•½</h3>
        <div id="appointmentFormMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="appointmentForm" th:action="@{/appointment}" method="post">
            <table>
                <tr>
                    <td><label for="patient_id">í™˜ì ID:</label></td>
                    <td><input type="number" id="patient_id" name="patient_id" required></td>
                </tr>
                <tr>
                    <td><label for="staff_id">ì˜ë£Œì§„ ID:</label></td>
                    <td><input type="number" id="staff_id" name="staff_id" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_date">ì˜ˆì•½ ë‚ ì§œ:</label></td>
                    <td><input type="date" id="appointment_date" name="appointment_date" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_time">ì˜ˆì•½ ì‹œê°„:</label></td>
                    <td><input type="time" id="appointment_time" name="appointment_time" required></td>
                </tr>
                <tr>
                    <td><input type="hidden" id="status" name="status" value="ì˜ˆì•½"></td>
                </tr>
                <tr>
                    <td><label for="remarks">ë©”ëª¨:</label></td>
                    <td><input type="text" id="remarks" name="remarks" required></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: center; padding-top:10px;">
                        <button type="submit">ì˜ˆì•½ ë“±ë¡</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<!-- ì˜ˆì•½ ëª©ë¡ ëª¨ë‹¬ -->
<div id="appointmentListModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentListModal">&times;</span>
        <h3>ì§„ë£Œ ì˜ˆì•½ ëª©ë¡</h3>
        <div id="appointmentListContainer"></div>
    </div>
</div>

<!-- í˜¸ì¶œ ëª¨ë‹¬ (ê°„í˜¸ì‚¬ í˜ì´ì§€ì—ì„œ í˜¸ì¶œ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë°”ë¡œ ë„ì›€) -->
<div id="callModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeCallModal">&times;</span>
        <h3>í˜¸ì¶œëœ í™˜ì ì •ë³´</h3>
        <div id="callPatientInfo">
            <!-- AJAXë¡œ í˜¸ì¶œ í™˜ì ì •ë³´ë¥¼ ë¡œë“œ -->
        </div>
        <button id="confirmCallBtn">í™•ì¸</button>
        <button id="holdCallBtn">ë³´ë¥˜</button>
    </div>
</div>

<!-- ì ‘ìˆ˜ ëª¨ë‹¬ -->
<div id="receptionModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeReceptionModal">&times;</span>
        <h3>ì§„ë£Œ ì ‘ìˆ˜</h3>

        <form id="receptionForm" action="/patient/register" method="post">
            <!-- ìˆ¨ê²¨ì§„/ì½ê¸°ì „ìš© í™˜ì ID -->
            <label for="patientId">í™˜ì ID:</label>
            <input type="text" id="patientId" name="patientId" readonly />

            <!-- ì˜ì‚¬ ID (ì§ì ‘ ì…ë ¥) -->
            <label for="doctorId">ì˜ì‚¬ ID:</label>
            <input type="number" id="doctorId" name="doctorId" />

            <!-- ì§„ë£Œ ë‚ ì§œ/ì‹œê°„ -->
            <label for="visitDate">ì§„ë£Œ ë‚ ì§œ:</label>
            <input type="date" id="visitDate" name="visitDate" />
            <label for="visitTime">ì§„ë£Œ ì‹œê°„:</label>
            <input type="time" id="visitTime" name="visitTime" />

            <!-- ì§„ë£Œ ì‚¬ìœ  -->
            <label for="visitReason">ì§„ë£Œ ì‚¬ìœ :</label>
            <textarea id="visitReason" name="visitReason"></textarea>

            <!-- ë°©ë¬¸ ìœ í˜• -->
            <label for="visitType">ë°©ë¬¸ ìœ í˜•:</label>
            <select id="visitType" name="visitType">
                <option value="ê²€ì§„">ê²€ì§„</option>
                <option value="ìƒë‹´">ìƒë‹´</option>
                <option value="ì™¸ë˜">ì™¸ë˜</option>
                <option value="ì…ì›">ì…ì›</option>
                <option value="ì‘ê¸‰">ì‘ê¸‰</option>
                <option value="ì¬ì§„">ì¬ì§„</option>
                <option value="ì§„ë£Œì˜ˆì•½">ì§„ë£Œì˜ˆì•½</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>

            <br><br>
            <button type="submit">ì ‘ìˆ˜ ë“±ë¡</button>
        </form>
        <div id="receptionFormMessage" style="margin-top: 10px; text-align: center;"></div>
    </div>
</div>

<!-- ì²˜ë°©ì „ ëª¨ë‹¬ -->
<div id="prescriptionModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closePrescriptionModal">&times;</span>
        <h3>ìµœê·¼ ì§„ë£Œ ê¸°ë¡</h3>
        <table>
            <thead>
            <tr><th>ë°©ë¬¸ì¼</th><th>ë°©ë¬¸ì‹œê°„</th><th>ì‚¬ìœ </th><th>ì²˜ë°©ì „ ì¶œë ¥</th></tr>
            </thead>
            <tbody id="visitListTbody">
            <!-- JSë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </tbody>
        </table>
    </div>
</div>

<!-- í†µê³„ ëª¨ë‹¬ -->
<div id="statsModal" class="modal">
    <div class="modal-content">
        <span id="closeStatsModal" style="float:right; cursor:pointer;">&times;</span>
        <h2>í˜„í™© í†µê³„</h2>

        <!-- ì§„ë£Œ ê±´ìˆ˜ ì¶”ì´ -->
        <h3>ì§„ë£Œ ìˆ˜ ì¶”ì„¸</h3>
        <canvas id="visitTrendChart"></canvas>

        <!-- ì²˜ë°© ì•½ top 5 -->
        <h3>ì²˜ë°© ì•½ Top 5</h3>
        <canvas id="topDrugsChart"></canvas>

        <!-- ì—°ë ¹ëŒ€ë³„ í™˜ì ë¶„í¬ -->
        <h3>ì—°ë ¹ëŒ€ë³„ í™˜ì ë¶„í¬</h3>
        <canvas id="ageDistributionChart"></canvas>
    </div>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
<script>
    // ----------------------
    // ê¸°ë³¸ ì‹œê°„ ë° ì±„íŒ… ê¸°ëŠ¥
    // ----------------------
    function updateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
        const dayOfWeek = dayNames[now.getDay()];
        let hour = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = hour < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour;
        const hourStr = String(hour).padStart(2, '0');
        document.getElementById("timeInfo").textContent = `${year}.${month}.${date} ${dayOfWeek} ${ampm} ${hourStr}:${minutes}:${seconds}`;
    }
    setInterval(updateTime, 1000);
    document.getElementById("chatButton").addEventListener("click", function(){
        alert("ì±„íŒ… ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤!");
    });

    // ----------------------
    // ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
    // ----------------------
    function refreshWaitingList() {
        fetch('/patient/waiting')
            .then(response => response.text())
            .then(html => { document.getElementById("patientList").innerHTML = html; })
            .catch(error => console.error("ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ì˜¤ë¥˜:", error));
    }
    refreshWaitingList();
    setInterval(refreshWaitingList, 5000);

    // ----------------------
    // ì •ë ¬ ê¸°ëŠ¥
    // ----------------------
    function sortList() {
        const select = document.getElementById('sortSelect');
        const order = select.value;
        const list = document.getElementById('patientList');
        let items = Array.from(list.getElementsByTagName('li'));
        items.sort((a, b) => {
            return order === 'asc' ?
                a.textContent.trim().localeCompare(b.textContent.trim(), 'ko')
                : b.textContent.trim().localeCompare(a.textContent.trim(), 'ko');
        });
        list.innerHTML = "";
        items.forEach(item => list.appendChild(item));
    }


    // ----------------------
    // ì ‘ìˆ˜ ê¸°ëŠ¥
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('register-btn')) {
            const patientId = e.target.getAttribute('data-id');
            // AJAX POST ìš”ì²­: í™˜ì ì ‘ìˆ˜ ì²˜ë¦¬
            fetch('/patient/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'patientId=' + encodeURIComponent(patientId)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // alertë¡œ ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ
                    alert(data.message);
                    // ì„±ê³µ ì‹œì—ë§Œ ëª¨ë‹¬ ë‹«ê³  ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                    if(data.success) {
                        document.getElementById("searchResultModal").style.display = "none";
                        refreshWaitingList();
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("í™˜ì ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                });
        }
    });
    // ì „ì—­ ë³€ìˆ˜ì— ì‚­ì œí•  í™˜ì ID ì €ì¥
    let deletePatientId = null;
    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ë‚´)
    document.getElementById('patientList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
            deletePatientId = e.target.getAttribute('data-id');
            // í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
            document.getElementById("confirmModal").style.display = "block";
        }
    });
    // í™•ì¸ ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬
    document.getElementById("closeConfirmModal").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
    };

    // "ì•„ë‹ˆì˜¤" ë²„íŠ¼ ì²˜ë¦¬
    document.getElementById("confirmNoBtn").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
        deletePatientId = null;
    };

    // "ì˜ˆ" ë²„íŠ¼ ì²˜ë¦¬: ì‹¤ì œë¡œ í™˜ì ì‚­ì œ (ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°)
    document.getElementById("confirmYesBtn").onclick = function() {
        if (!deletePatientId) return;
        fetch('/patient/waiting/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'patientId=' + encodeURIComponent(deletePatientId)
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    refreshWaitingList();
                    // â”€â”€ ì—¬ê¸°ì— MedicalVisit ë ˆì½”ë“œ ì‚­ì œ ìš”ì²­ ì¶”ê°€ â”€â”€
                    return fetch('/medicalvisit/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ patientId: deletePatientId })
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(res2 => res2.json())
            .then(json2 => {
                if (json2.success) {
                    console.log('MedicalVisit ìµœì‹  ë ˆì½”ë“œ ì‚­ì œ ì™„ë£Œ');
                } else {
                    console.warn('MedicalVisit ì‚­ì œ ì‹¤íŒ¨:', json2.message);
                }
            })
            .catch(err => {
                console.error("ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
                alert("ëŒ€ê¸°ì—´ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            })
            .finally(() => {
                deletePatientId = null;
                document.getElementById("confirmModal").style.display = "none";
            });
    };

    setInterval(() => {
        refreshWaitingList();
    }, 5000); // 5ì´ˆ

    function refreshStats() {
        fetch('/patient/stats')
            .then(response => {
                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜");
                return response.json();
            })
            .then(data => {
                document.getElementById('waitingCount').innerText = data.waitingCount + "ëª…";
                document.getElementById('collectionCount').innerText = data.collectionCount + "ëª…";
            })
            .catch(error => {
                console.error("Stats refresh error:", error);
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë° 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    refreshStats();
    setInterval(refreshStats, 5000);


    // ----------------------
    // í˜¸ì¶œ ëª¨ë‹¬ ê¸°ëŠ¥ (ê°„í˜¸ì‚¬ í˜ì´ì§€)
    // ----------------------
    window.addEventListener("storage", function(event) {
        if (event.key === "callPatient" && event.newValue) {
            try {
                const callInfo = JSON.parse(event.newValue);
                const patientId = callInfo.patientId;
                if (!patientId) return;
                fetch('/patient/call?patientId=' + encodeURIComponent(patientId))
                    .then(response => response.json())
                    .then(patient => {
                        document.getElementById("callPatientInfo").innerHTML = `
            <p><strong>ì´ë¦„:</strong> ${patient.name}</p>
            <p><strong>ìƒë…„ì›”ì¼:</strong> ${patient.date_of_birth}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${patient.phone_number}</p>
            <p><strong>ì´ë©”ì¼:</strong> ${patient.email}</p>
            <p><strong>ì£¼ì†Œ:</strong> ${patient.address}</p>
          `;
                        document.getElementById("callModal").dataset.patientId = patientId;
                        document.getElementById("callModal").style.display = "block";
                    })
                    .catch(error => console.error("í˜¸ì¶œ í™˜ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error));
            } catch(e) {
                console.error("í˜¸ì¶œ ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:", e);
            }
        }
    });
    document.getElementById("closeCallModal").onclick = function() {
        document.getElementById("callModal").style.display = "none";
    };

    // í˜¸ì¶œ ëª¨ë‹¬ "í™•ì¸" ë²„íŠ¼ (nurse í˜ì´ì§€)
    document.getElementById("confirmCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        // ë°±ì—”ë“œì—ì„œ í™˜ìì˜ ìƒíƒœë¥¼ 'ì§„ë£Œì¤‘' (called = true)ë¡œ ì—…ë°ì´íŠ¸í•˜ë„ë¡ í•¨
        fetch('/patient/call/confirm', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                // ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ëŠ” ì¦‰ì‹œ ì œê±°í•˜ì§€ ì•Šê³ , ë‚˜ì¤‘ì— ì˜ì‚¬ í˜ì´ì§€ì—ì„œ ë²„íŠ¼ ìƒíƒœì— ë”°ë¼ ì—…ë°ì´íŠ¸ë¨
                // (ì˜ˆ: ì£¼ê¸°ì  ìƒˆë¡œê³ ì¹¨ ì‹œ í™˜ìì˜ called í”Œë˜ê·¸ê°€ trueë¡œ ë°˜ì˜ë¨)
            })
            .catch(error => {
                console.error("í˜¸ì¶œ í™•ì¸ ì‹¤íŒ¨:", error);
                alert("í˜¸ì¶œ í™•ì¸ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
            });
    });

    // í˜¸ì¶œ ëª¨ë‹¬ "ë³´ë¥˜" ë²„íŠ¼ ì²˜ë¦¬
    document.getElementById("holdCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        fetch('/patient/call/hold', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                refreshWaitingList();
            })
            .catch(error => {
                console.error("ë³´ë¥˜ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
                alert("ë³´ë¥˜ ì²˜ë¦¬ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
            });
    });

    // ----------------------
    // í™˜ì ê²€ìƒ‰ ê²°ê³¼ ëª¨ë‹¬ ì²˜ë¦¬
    // ----------------------
    const searchBar = document.getElementById("topSearchBar");
    searchBar.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const keyword = searchBar.value.trim();
            if (!keyword) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            fetch(`/patient/search?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("searchResultContainer").innerHTML = html;
                    document.getElementById("searchResultModal").style.display = "block";
                })
                .catch(error => {
                    console.error("ê²€ìƒ‰ ì‹¤íŒ¨:", error);
                    alert("ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
        }
    });
    const searchResultModal = document.getElementById("searchResultModal");
    const closeSearchModal = document.getElementById("closeSearchModal");
    closeSearchModal.onclick = function() {
        searchResultModal.style.display = "none";
    };
    window.onclick = function(event) {
        if (event.target === searchResultModal) {
            searchResultModal.style.display = "none";
        }
    };

    // ----------------------
    // ì˜ˆì•½ ëª¨ë‹¬ ì²˜ë¦¬
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('appointment-btn')) {
            const patientId = e.target.getAttribute('data-id');
            if (!patientId) {
                alert("í™˜ì IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
            }
            document.getElementById('patient_id').value = patientId;
            document.getElementById('appointmentModal').style.display = "block";
        }
    });
    const appointmentModal = document.getElementById("appointmentModal");
    const closeAppointmentModalBtn = document.getElementById("closeAppointmentModal");
    closeAppointmentModalBtn.onclick = function() {
        appointmentModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentModal) {
            appointmentModal.style.display = "none";
        }
    });
    const appointmentForm = document.getElementById("appointmentForm");
    const appointmentFormMessage = document.getElementById("appointmentFormMessage");
    appointmentForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(appointmentForm);
        fetch(appointmentForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    appointmentFormMessage.style.color = "green";
                    appointmentFormMessage.textContent = data.message;
                    setTimeout(() => {
                        appointmentModal.style.display = "none";
                        appointmentForm.reset();
                        appointmentFormMessage.textContent = "";
                    }, 1500);
                } else {
                    appointmentFormMessage.style.color = "red";
                    appointmentFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("ì˜ˆì•½ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", error);
                appointmentFormMessage.style.color = "red";
                appointmentFormMessage.textContent = "ì˜ˆì•½ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.";
            });
    });

    // ì˜ˆì•½ ëª©ë¡ ëª¨ë‹¬ ì²˜ë¦¬
    const openAppointmentListModalBtn = document.getElementById("openAppointmentListModalBtn");
    const appointmentListModal = document.getElementById("appointmentListModal");
    const closeAppointmentListModalBtn = document.getElementById("closeAppointmentListModal");
    openAppointmentListModalBtn.onclick = function() {
        fetch('/appointment/list')
            .then(response => {
                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜");
                return response.text();
            })
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
                appointmentListModal.style.display = "block";
            })
            .catch(error => {
                console.error("ì˜ˆì•½ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                alert("ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    };
    closeAppointmentListModalBtn.onclick = function() {
        appointmentListModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentListModal) {
            appointmentListModal.style.display = "none";
        }
    });

    // ----------------------
    // ìº˜ë¦°ë” ì´ë²¤íŠ¸ (ì¼ì • ì¶”ê°€) â€“ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì²˜ë¦¬
    // ----------------------
    (function(){
        let events = {}; // { "YYYY-MM-DD": [{ title: "íšŒì˜", desc: "ë‚´ìš©" }, ...] }
        function renderEventCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month+1, 0).getDate();
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = "";
            let row = document.createElement('tr');
            let cellCount = 0;
            for(let i=0; i<firstDay; i++){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            for(let d=1; d<=lastDate; d++){
                let cell = document.createElement('td');
                let btn = document.createElement('button');
                btn.className = 'day-btn';
                btn.textContent = d;
                let dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(events[dateKey] && events[dateKey].length > 0){
                    btn.classList.add('has-event');
                }
                btn.addEventListener('click', function(){
                    openEventModal(dateKey);
                });
                cell.appendChild(btn);
                row.appendChild(cell);
                cellCount++;
                if(cellCount % 7 === 0){
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                }
            }
            while(cellCount % 7 !== 0){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            calendarBody.appendChild(row);
        }
        function refreshEventList() {
            const eventListElem = document.getElementById("eventList");
            eventListElem.innerHTML = "";
            const currentMonthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}`;
            for(let dateKey in events){
                if(dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0){
                    let li = document.createElement('li');
                    li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                    eventListElem.appendChild(li);
                }
            }
        }
        const eventModal = document.getElementById("eventModal");
        const closeEventModalBtn = document.getElementById("closeEventModal");
        const modalDateDisplay = document.getElementById("modalDateDisplay");
        let selectedDateKey = "";
        function openEventModal(dateKey) {
            selectedDateKey = dateKey;
            modalDateDisplay.textContent = "ë‚ ì§œ: " + dateKey;
            eventModal.style.display = "block";
        }
        closeEventModalBtn.onclick = function(){
            eventModal.style.display = "none";
        };
        window.addEventListener('click', function(event){
            if(event.target === eventModal){
                eventModal.style.display = "none";
            }
        });
        document.getElementById("eventForm").addEventListener("submit", function(e){
            e.preventDefault();
            const title = document.getElementById("eventTitle").value.trim();
            const desc = document.getElementById("eventDesc").value.trim();
            if(!title){
                alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            if(!events[selectedDateKey]){
                events[selectedDateKey] = [];
            }
            events[selectedDateKey].push({ title: title, desc: desc });
            eventModal.style.display = "none";
            document.getElementById("eventForm").reset();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()-1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()+1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        updateCalendarBanner();
        renderEventCalendar();
        refreshEventList();
    })();

</script>
<!-- ì ‘ìˆ˜ ëª¨ë‹¬ ì²˜ë¦¬ -->
<script>
    function openReceptionModal(patientId) {
        document.getElementById("patientId").value = patientId;
        let now = new Date();
        document.getElementById("visitDate").valueAsDate = now;
        let hh = String(now.getHours()).padStart(2, '0');
        let mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById("visitTime").value = hh + ":" + mm;
        document.getElementById("receptionModal").style.display = "block";
    }

    document.getElementById("closeReceptionModal").onclick = function() {
        document.getElementById("receptionModal").style.display = "none";
    };

    const receptionForm = document.getElementById("receptionForm");
    const receptionFormMessage = document.getElementById("receptionFormMessage");
    receptionForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(receptionForm);

        fetch(receptionForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    receptionFormMessage.style.color = "green";
                    receptionFormMessage.textContent = data.message;
                    setTimeout(() => {
                        document.getElementById("receptionModal").style.display = "none";
                        receptionForm.reset();
                        receptionFormMessage.textContent = "";
                        refreshWaitingList();
                    }, 1000);
                } else {
                    receptionFormMessage.style.color = "red";
                    receptionFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("ì ‘ìˆ˜ ë“±ë¡ ì‹¤íŒ¨:", error);
                receptionFormMessage.style.color = "red";
                receptionFormMessage.textContent = "ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
            });
    });

    // ì ‘ìˆ˜ ëª¨ë‹¬ì—ì„œ í¼ ì œì¶œ ì‹œ ì²˜ë¦¬
    document.getElementById("receptionForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(document.getElementById("receptionForm"));

        // ë¨¼ì € /patient/register API í˜¸ì¶œ (í™˜ì ëŒ€ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸)
        fetch('/patient/register', {
            method: "POST",
            body: new URLSearchParams({ patientId: formData.get("patientId") })
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // í™˜ì ì ‘ìˆ˜ê°€ ì„±ê³µí•˜ë©´, ì§„ë£Œ ì ‘ìˆ˜ ì •ë³´ë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´ /medicalvisit/create í˜¸ì¶œ
                    return fetch('/medicalvisit/create', {
                        method: "POST",
                        body: new URLSearchParams({
                            patientId: formData.get("patientId"),
                            doctorId: formData.get("doctorId"),
                            visitDate: formData.get("visitDate"),
                            visitTime: formData.get("visitTime"),
                            visitReason: formData.get("visitReason"),
                            visitType: formData.get("visitType")
                        })
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert("ì§„ë£Œ ì ‘ìˆ˜ ë“±ë¡ ì„±ê³µ");
                    document.getElementById("receptionModal").style.display = "none";
                    // í•„ìš”ì‹œ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ ë“± ì¶”ê°€ ì‘ì—…
                } else {
                    alert("ì§„ë£Œ ì ‘ìˆ˜ ë“±ë¡ ì‹¤íŒ¨: " + data.message);
                }
            })
            .catch(error => {
                console.error("ì ‘ìˆ˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                alert("ì ‘ìˆ˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            });
    });
</script>
<script>
    document.getElementById("openModalBtn").addEventListener("click", function() {
        document.getElementById("patientModal").style.display = "block";
    });
    document.getElementById("closePatientModal").onclick = function() {
        document.getElementById("patientModal").style.display = "none";
    };
    document.getElementById("patientForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                const formMessage = document.getElementById("formMessage");
                if (data.success) {
                    formMessage.style.color = "green";
                    formMessage.textContent = data.message;
                    // 1.5ì´ˆ í›„ì— ëª¨ë‹¬ì°½ ë‹«ê³  í¼ ë¦¬ì…‹
                    setTimeout(() => {
                        document.getElementById("patientModal").style.display = "none";
                        form.reset();
                        formMessage.textContent = "";
                    }, 1500);
                } else {
                    formMessage.style.color = "red";
                    formMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("í™˜ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                const formMessage = document.getElementById("formMessage");
                formMessage.style.color = "red";
                formMessage.textContent = "í™˜ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
            });
    });
</script>

<script>
    // ì „ì—­ ë³€ìˆ˜: ì´ë²¤íŠ¸ ì •ë³´ë¥¼ ì €ì¥í•  ê°ì²´ (ì˜ˆ: { "2025-03-15": [ { eventId: 1, title:"íšŒì˜", description:"ë‚´ìš©" }, ... ] })
    var events = {};

    // í˜„ì¬ ë‹¬ë ¥ ê¸°ì¤€ ë‚ ì§œ (ì›” ë‹¨ìœ„)
    var currentDate = new Date();
    currentDate.setDate(1);

    // ì„ íƒí•œ ë‚ ì§œ (YYYY-MM-DD)
    var selectedDateKey = "";

    // í˜„ì¬ ì‚¬ìš©í•  ì—­í• 
    var calendarRole = "nurse";

    // ìº˜ë¦°ë” ë°°ë„ˆ ì—…ë°ì´íŠ¸
    function updateCalendarBanner() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var monthStr = String(month + 1).padStart(2, '0');
        document.getElementById("calendarMonth").textContent = `${year}.${monthStr}`;
        var today = new Date();
        var tYear = today.getFullYear();
        var tMonth = String(today.getMonth() + 1).padStart(2, '0');
        var tDate = String(today.getDate()).padStart(2, '0');
        document.getElementById("todayDate").textContent = `ì˜¤ëŠ˜: ${tYear}.${tMonth}.${tDate}`;
    }

    // ìº˜ë¦°ë” ë Œë”ë§: ë‚ ì§œ ë²„íŠ¼ ìƒì„±
    function renderCalendar() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var firstDay = new Date(year, month, 1).getDay();
        var lastDate = new Date(year, month + 1, 0).getDate();
        var calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = "";
        var row = document.createElement("tr");
        var cellCount = 0;

        // ì´ì „ ë‹¬ ë¹ˆ ì…€
        for (var i = 0; i < firstDay; i++) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }

        // í˜„ì¬ ë‹¬ ë‚ ì§œ ë²„íŠ¼ ìƒì„±
        for (var d = 1; d <= lastDate; d++) {
            var cell = document.createElement("td");
            var btn = document.createElement("button");
            btn.className = "day-btn";
            btn.textContent = d;
            var fullDate = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            btn.setAttribute("data-date", fullDate);
            // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
            var today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                btn.classList.add("today");
            }
            btn.addEventListener("click", function() {
                openEventModal(this.getAttribute("data-date"));
            });
            cell.appendChild(btn);
            row.appendChild(cell);
            cellCount++;
            if (cellCount % 7 === 0) {
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }

        // ë‚¨ì€ ì…€ ì±„ìš°ê¸°
        while (cellCount % 7 !== 0) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        calendarBody.appendChild(row);
    }

    // ì›”ê°„ ì´ë²¤íŠ¸ ëª©ë¡ ê°±ì‹  (ì„œë²„ì—ì„œ ì¡°íšŒí•˜ì—¬ events ê°ì²´ ì—…ë°ì´íŠ¸ í›„ í™”ë©´ ê°±ì‹ )
    function refreshMonthlyEventList() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1;
        // AJAX ìš”ì²­: /calendar/{role}/events?year=YYYY&month=MM
        fetch(`/calendar/${calendarRole}/events?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                // dataëŠ” CalendarEvent ê°ì²´ ë°°ì—´ì…ë‹ˆë‹¤.
                // ì´ë²¤íŠ¸ë¥¼ ë‚ ì§œë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ events ì „ì—­ ê°ì²´ì— ì €ì¥
                events = {};  // ì´ˆê¸°í™”
                data.forEach(function(ev) {
                    var key = ev.eventDate;
                    if (!events[key]) {
                        events[key] = [];
                    }
                    events[key].push(ev);
                });
                // í•˜ë‹¨ ì›”ê°„ ì´ë²¤íŠ¸ ëª©ë¡ ê°±ì‹ 
                var listElem = document.getElementById("eventList");
                listElem.innerHTML = "";
                var currentMonthPrefix = `${year}-${String(month).padStart(2,'0')}`;
                for (var dateKey in events) {
                    if (dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0) {
                        var li = document.createElement("li");
                        li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                        listElem.appendChild(li);
                    }
                }
            })
            .catch(error => {
                console.error("ì›”ê°„ ì´ë²¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:", error);
            });
    }

    // ëª¨ë‹¬ ì—´ê¸°: í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì¡´ ì¼ì • ëª©ë¡ì„ ë¡œë“œ ë° ëª¨ë‹¬ í¼ ì´ˆê¸°í™”
    function openEventModal(dateKey) {
        selectedDateKey = dateKey;
        document.getElementById("selectedDateDisplay").textContent = dateKey;

        var existingEventsDiv = document.getElementById("existingEvents");
        if (events[dateKey] && events[dateKey].length > 0) {
            renderExistingEvents(dateKey, events[dateKey]);
        } else {
            existingEventsDiv.innerHTML = "<em style='color:#999;'>ì¼ì • ì—†ìŒ</em>";
        }

        // ëª¨ë‹¬ í¼ ì´ˆê¸°í™”: ì´ì „ ìˆ˜ì • ì •ë³´ ì‚­ì œ
        document.getElementById("eventTitleInput").value = "";
        document.getElementById("eventDescInput").value = "";
        document.getElementById("eventIdInput").value = "";
        document.getElementById("calendarEventModalTitle").textContent = "ì¼ì • ì¶”ê°€";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // renderExistingEvents: ì„ íƒí•œ ë‚ ì§œì˜ ì´ë²¤íŠ¸ ëª©ë¡ì„ ë Œë”ë§ (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í¬í•¨)
    function renderExistingEvents(dateKey, eventsForDate) {
        const container = document.getElementById("existingEvents");
        container.innerHTML = "";
        if (eventsForDate && eventsForDate.length > 0) {
            eventsForDate.forEach(event => {
                const eventDiv = document.createElement("div");
                eventDiv.style.display = "flex";
                eventDiv.style.justifyContent = "space-between";
                eventDiv.style.alignItems = "center";
                eventDiv.style.marginBottom = "4px";

                // ì´ë²¤íŠ¸ ì œëª©ê³¼ ì„¤ëª… í‘œì‹œ
                const infoSpan = document.createElement("span");
                infoSpan.textContent = `${event.title} - ${event.description}`;
                eventDiv.appendChild(infoSpan);

                // ë²„íŠ¼ ë˜í¼ë¥¼ ìƒì„±í•˜ê³  flex ì„¤ì • (gapì„ 0ìœ¼ë¡œ)
                const btnWrapper = document.createElement("div");
                btnWrapper.style.display = "flex";
                btnWrapper.style.gap = "0px";  // ë²„íŠ¼ë“¤ ì‚¬ì´ ì—¬ë°± 0

                // ìˆ˜ì • ë²„íŠ¼ ìƒì„± (ì—¬ê¸°ì„œëŠ” marginì„ ì œê±°)
                const editBtn = document.createElement("button");
                editBtn.textContent = "ìˆ˜ì •";
                editBtn.style.marginLeft = "0px";  // margin ì œê±°
                editBtn.addEventListener("click", function() {
                    openEventModalForEdit(dateKey, event);
                });
                btnWrapper.appendChild(editBtn);

                // ì‚­ì œ ë²„íŠ¼ ìƒì„± (ì—¬ê¸°ë„ margin ì œê±°)
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "ì‚­ì œ";
                deleteBtn.style.marginLeft = "0px";  // margin ì œê±°
                deleteBtn.addEventListener("click", function() {
                    deleteCalendarEvent(dateKey, event.eventId);
                });
                btnWrapper.appendChild(deleteBtn);

                // ë²„íŠ¼ ë˜í¼ë¥¼ ì˜¤ë¥¸ìª½ì— ë¶™ì—¬ë„£ê¸°
                eventDiv.appendChild(btnWrapper);
                container.appendChild(eventDiv);
            });
        } else {
            container.innerHTML = "<em style='color:#999;'>ì¼ì • ì—†ìŒ</em>";
        }
    }

    // ìˆ˜ì • ëª¨ë‹¬: ê¸°ì¡´ ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ í¼ì— ë¡œë“œ
    function openEventModalForEdit(dateKey, event) {
        document.getElementById("selectedDateDisplay").textContent = dateKey;
        document.getElementById("eventTitleInput").value = event.title;
        document.getElementById("eventDescInput").value = event.description;
        document.getElementById("eventIdInput").value = event.eventId;
        document.getElementById("calendarEventModalTitle").textContent = "ì¼ì • ìˆ˜ì •";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // ì‚­ì œ ì²˜ë¦¬: ë°±ì—”ë“œ ì‚­ì œ API í˜¸ì¶œ í›„ ì´ë²¤íŠ¸ ëª©ë¡ ê°±ì‹ 
    function deleteCalendarEvent(dateKey, eventId) {
        if (confirm("í•´ë‹¹ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/calendar/delete?eventId=${eventId}`, {
                method: "POST"
            })
                .then(response => response.json())
                .then(function(data) {
                    if (data.success) {
                        alert("ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        if (events[dateKey]) {
                            events[dateKey] = events[dateKey].filter(ev => ev.eventId !== eventId);
                            renderExistingEvents(dateKey, events[dateKey]);
                        }
                        refreshMonthlyEventList();
                    } else {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + data.message);
                    }
                })
                .catch(function(error) {
                    console.error("ì‚­ì œ ìš”ì²­ ì˜¤ë¥˜:", error);
                    alert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                });
        }
    }

    // ëª¨ë‹¬ í¼ ì œì¶œ: ì‹ ê·œ ìƒì„± ë˜ëŠ” ìˆ˜ì • ì‘ì—… ì²˜ë¦¬
    document.getElementById("calendarEventForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var dateStr = document.getElementById("selectedDateDisplay").textContent;
        var title = document.getElementById("eventTitleInput").value.trim();
        var desc = document.getElementById("eventDescInput").value.trim();
        var eventId = document.getElementById("eventIdInput").value.trim(); // ìˆ˜ì • ì‹œ ê°’ ì¡´ì¬

        if (!title) {
            alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        var url = `/calendar/${calendarRole}/save?eventDate=${encodeURIComponent(dateStr)}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(desc)}`;
        if (eventId) {
            url += `&eventId=${encodeURIComponent(eventId)}`;
        }

        fetch(url, { method: "POST" })
            .then(response => response.json())
            .then(function(data) {
                alert(data.message);
                document.getElementById("calendarEventModal").style.display = "none";
                // ìƒˆë¡œ ì €ì¥ëœ ì´ë²¤íŠ¸ë¥¼ ê°±ì‹ í•˜ê¸° ìœ„í•´ ë¦¬í”„ë ˆì‹œ
                refreshMonthlyEventList();
                renderCalendar();
            })
            .catch(function(error) {
                console.error("ì €ì¥ ì˜¤ë¥˜:", error);
                alert("ì¼ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            });
    });

    // ì´ì „/ë‹¤ìŒ ë‹¬ ë²„íŠ¼ ì²˜ë¦¬
    document.getElementById("prevMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });
    document.getElementById("nextMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });

    // ì´ˆê¸° ì‹¤í–‰
    updateCalendarBanner();
    renderCalendar();
    refreshMonthlyEventList();

    document.getElementById("closeCalendarEventModal").onclick = function() {
        document.getElementById("calendarEventModal").style.display = "none";
    };

    document.getElementById("calendarEventModal").addEventListener("click", function(event) {
        if (event.target === this) {
            this.style.display = "none";
        }
    });


</script>
<script>
    // ì˜ˆì•½ ëª©ë¡ì— ìˆëŠ” "ì ‘ìˆ˜" ë° "ì·¨ì†Œ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.addEventListener("click", function(e) {
        // "ì ‘ìˆ˜" ë²„íŠ¼ í´ë¦­ ì‹œ
        if (e.target && e.target.classList.contains("reception-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            var patientId = e.target.getAttribute("data-patient-id");
            if (!appointmentId || !patientId) return;
            if (confirm("ì´ ì˜ˆì•½ì„ ì ‘ìˆ˜ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìƒíƒœê°€ 'ì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸ë˜ê³  í™˜ì ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)")) {
                // ì²« ë²ˆì§¸: ì˜ˆì•½ ìƒíƒœë¥¼ 'ì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=ì™„ë£Œ`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ë‘ ë²ˆì§¸: patient í…Œì´ë¸”ì˜ waiting ê°’ì„ trueë¡œ ì—…ë°ì´íŠ¸ (/patient/register ì—”ë“œí¬ì¸íŠ¸ í™œìš©)
                            return fetch(`/patient/register?patientId=${patientId}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" }
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .then(response => response.json())
                    .then(function(data2) {
                        alert("ì ‘ìˆ˜ ì²˜ë¦¬ ì™„ë£Œ: " + data2.message);
                        // ì˜ˆì•½ ëª©ë¡ ë° ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                        refreshAppointmentList();
                        refreshWaitingList();  // ì´ í•¨ìˆ˜ëŠ” ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
                    })
                    .catch(function(error) {
                        console.error("ì ‘ìˆ˜ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                        alert("ì˜ˆì•½ ì ‘ìˆ˜ ë° ëŒ€ê¸° ë“±ë¡ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                    });
            }
        }
        // "ì·¨ì†Œ" ë²„íŠ¼ í´ë¦­ ì‹œ
        else if (e.target && e.target.classList.contains("cancel-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            if (confirm("ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=ì·¨ì†Œ`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(function(data) {
                        alert(data.message);
                        refreshAppointmentList();
                    })
                    .catch(function(error) {
                        console.error("ì·¨ì†Œ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                        alert("ì˜ˆì•½ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                    });
            }
        }
    });

    // ì˜ˆì•½ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜ (AJAXë¡œ ì˜ˆì•½ ëª©ë¡ fragment ì¬ë¡œë”©)
    function refreshAppointmentList() {
        fetch('/appointment/list')
            .then(response => response.text())
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
            })
            .catch(function(error) {
                console.error("ì˜ˆì•½ ëª©ë¡ ê°±ì‹  ì˜¤ë¥˜:", error);
            });
    }

    // ì˜ˆì‹œ: ëŒ€ê¸° í™˜ì ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜ (ë³„ë„ë¡œ êµ¬í˜„)
    function refreshWaitingList() {
        fetch('/patient/doctor/waiting')
            .then(response => response.text())
            .then(html => {
                document.getElementById("doctorPatientList").innerHTML = html;
            })
            .catch(function(error) {
                console.error("ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ê°±ì‹  ì˜¤ë¥˜:", error);
            });
    }

</script>
<script>
    const prescModal = document.getElementById('prescriptionModal');
    document.getElementById('openPrescriptionModalBtn').onclick = () => {
        // ë°©ë¬¸ ë¦¬ìŠ¤íŠ¸ ë°›ì•„ì˜¤ê¸°
        fetch('/nurse/prescriptions')
            .then(r=>r.json())
            .then(visits=>{
                const tb = document.getElementById('visitListTbody');
                tb.innerHTML = visits.map(v=>`
          <tr>
            <td>${v.visitDate}</td>
            <td>${v.visitTime}</td>
            <td>${v.visitReason}</td>
            <td><button onclick="printPrescription(${v.visitId})">ì¶œë ¥</button></td>
          </tr>
        `).join('');
                prescModal.style.display = 'flex';
            });
    };
    document.getElementById('closePrescriptionModal').onclick = () => prescModal.style.display='none';

    // ì¶œë ¥: ìƒˆ íƒ­ìœ¼ë¡œ PDF ì—´ê¸°
    function printPrescription(visitId) {
        window.open(`/nurse/prescriptions/print/${visitId}`, '_blank');
    }
</script>
<script>
    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    const modal = document.getElementById("statsModal");
    document.getElementById("openStatsModalBtn").onclick = () => {
        modal.style.display = "block";
        loadAllStats();
    };
    document.getElementById("closeStatsModal").onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

    async function loadAllStats() {
        const res = await fetch("/nurse/stats/all");
        const data = await res.json();

        // ì§„ë£Œ ìˆ˜ ì¶”ì„¸
        const vtc = document.getElementById("visitTrendChart").getContext("2d");
        new Chart(vtc, {
            type: 'line',
            data: {
                labels: data.visits.map(d => d.date),
                datasets: [{
                    label: 'ì§„ë£Œ ê±´ìˆ˜',
                    data: data.visits.map(d => d.count),
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return Number(value).toFixed(0); // yì¶•ì„ í•­ìƒ ì •ìˆ˜ë¡œ
                            }
                        }
                    }
                }
            }
        });

        // ì•½ top 5
        const tdctx = document.getElementById("topDrugsChart").getContext("2d");
        new Chart(tdctx, {
            type: 'bar',
            data: {
                labels: data.topDrugs.map(d => d.name),
                datasets: [{
                    label: 'ì²˜ë°© ìˆ˜',
                    data: data.topDrugs.map(d => d.count),
                    borderWidth: 1
                }]
            },
            options: { responsive: true }
        });

        // ì—°ë ¹ëŒ€ë³„ ë¶„í¬
        const ac = document.getElementById("ageDistributionChart").getContext("2d");
        new Chart(ac, {
            type: 'doughnut',
            data: {
                labels: data.ageGroups.map(d => d.range),
                datasets: [{
                    label: 'ì¸ì›ìˆ˜',
                    data: data.ageGroups.map(d => d.count)
                }]
            },
            options: { responsive: true }
        });
    }
</script>
</body>
</html>