<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이비인후과 EMR - 간호사 메인화면</title>
    <link rel="stylesheet" th:href="@{/css/nurse_style.css}" />
    <style>
        /* 모달 기본 스타일 (필요시 nurse_style.css에서 별도 관리 가능) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
<!-- 헤더 영역 -->
<div class="header">
    <div class="left-section">
        <span class="greeting">반갑습니다. 홍길동 님</span>
        <button>오늘의 현황</button>
        <button>진료실</button>
    </div>
    <div class="center-section">
        <input id="topSearchBar" class="search-bar" type="text" placeholder="환자검색/이름/환자등록번호/생년월일/휴대폰번호">
    </div>
    <div class="right-section">
        <span class="time-info" id="timeInfo">00:00:00</span>
        <button class="chat-button" id="chatButton">&#128172;</button>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div class="container">
    <!-- 좌측 사이드바: 프로필 및 대기 환자 리스트 -->
    <div class="sidebar">
        <div class="profile-banner">
            <div class="profile-top">
                <img src="https://via.placeholder.com/40" alt="Profile Picture" class="profile-pic">
                <div class="profile-name">홍길동(간호사)</div>
            </div>
            <div class="profile-stats">
                <span class="status-label">대기</span>
                <span id="waitingCount" class="status-number">0명</span>
                <span class="status-separator">|</span>
                <span class="status-label">오늘 수납</span>
                <span id="collectionCount" class="status-number">0명</span>
            </div>
        </div>
        <div class="waiting-patient-list">
            <div class="list-header">
                <h3>접수 대기 환자 리스트</h3>
            </div>
            <div class="list-container">
                <ul id="patientList">
                </ul>
            </div>
        </div>
    </div>

    <!-- 중앙 메인 콘텐츠 -->
    <div class="main-content">
        <button id="openModalBtn" class="new-patient-btn">신규 환자 등록</button>
        <button id="openAppointmentListModalBtn" class="new-patient-btn">진료 예약 목록</button>
    </div>

    <!-- 우측 배너: 캘린더 영역 -->
    <div class="right-banner">
        <div class="calendar-banner">
            <button id="prevMonthBtn" title="이전 달">&#9664;</button>
            <span id="calendarMonth">2025.03</span>
            <button id="nextMonthBtn" title="다음 달">&#9654;</button>
            <div class="today-date" id="todayDate">오늘: 2025.03.13</div>
        </div>
        <table class="month-view" id="calendarTable">
            <thead>
            <tr>
                <th>일</th>
                <th>월</th>
                <th>화</th>
                <th>수</th>
                <th>목</th>
                <th>금</th>
                <th>토</th>
            </tr>
            </thead>
            <tbody id="calendarBody">
            <!-- 날짜 버튼이 JavaScript로 생성됨 -->
            </tbody>
        </table>
        <div id="monthEventList">
            <h3>이번 달 일정</h3>
            <ul id="eventList" style="list-style: none; padding: 0;"></ul>
        </div>

        <!-- 일정 추가/수정 모달 -->
        <div id="calendarEventModal" class="modal" style="display:none;">
            <div class="modal-content" style="background:#fff; padding:20px; border-radius:4px; width:300px; margin:100px auto; position:relative;">
                <span class="close" id="closeCalendarEventModal" style="position:absolute; top:8px; right:12px; cursor:pointer;">&times;</span>
                <h3 id="calendarEventModalTitle">일정 관리</h3>
                <!-- 선택한 날짜 표시 -->
                <p id="selectedDateDisplay" style="font-weight: bold;"></p>
                <!-- 기존 일정 목록 -->
                <div id="existingEvents" style="max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px; font-size:0.9rem;">
                    <em style="color:#999;">해당 날짜에 등록된 일정 없음</em>
                </div>
                <!-- 숨은 eventId 입력 -->
                <input type="hidden" id="eventIdInput" name="eventId" value="">
                <!-- 새 일정/수정 폼 -->
                <form id="calendarEventForm">
                    <div>
                        <label for="eventTitleInput">제목:</label><br>
                        <input type="text" id="eventTitleInput" name="eventTitle" required style="width:100%; box-sizing:border-box;">
                    </div>
                    <div style="margin-top:8px;">
                        <label for="eventDescInput">내용:</label><br>
                        <textarea id="eventDescInput" name="eventDesc" style="width:100%; box-sizing:border-box;"></textarea>
                    </div>
                    <div style="margin-top:12px; text-align:right;">
                        <button type="submit">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 모달 창 영역 -->

<!-- 신규 환자 등록 모달 (HTML 일부) -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closePatientModal">&times;</span>
        <h3>신규 환자 등록</h3>
        <!-- 여기서 formMessage 영역을 사용 -->
        <div id="formMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="patientForm" th:action="@{/patient}" method="post">
            <!-- 폼 내용 -->
            <table>
                <tr>
                    <td><label for="name">이름:</label></td>
                    <td><input type="text" id="name" name="name" required></td>
                    <td><label for="date_of_birth">생년월일:</label></td>
                    <td><input type="date" id="date_of_birth" name="date_of_birth" required></td>
                </tr>
                <tr>
                    <td><label for="gender">성별:</label></td>
                    <td>
                        <select id="gender" name="gender" required>
                            <option value="">선택</option>
                            <option value="남">남</option>
                            <option value="여">여</option>
                        </select>
                    </td>
                    <td><label for="phone_number">전화번호:</label></td>
                    <td><input type="text" id="phone_number" name="phone_number" required></td>
                </tr>
                <tr>
                    <td><label for="email">이메일:</label></td>
                    <td><input type="email" id="email" name="email" required></td>
                    <td><label for="address">주소:</label></td>
                    <td><input type="text" id="address" name="address" required></td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: center; padding-top:10px;">
                        <button type="submit">등록</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>


<!-- 환자 검색 결과 모달 -->
<div id="searchResultModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeSearchModal">&times;</span>
        <h3>검색 결과</h3>
        <div id="searchResultContainer"></div>
    </div>
</div>

<!-- 대기 리스트 삭제(호출 취소) 확인 모달 -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" id="closeConfirmModal">&times;</span>
        <h3>삭제 확인</h3>
        <p>해당 환자를 대기 리스트에서 제거하시겠습니까?</p>
        <button id="confirmYesBtn">&nbsp;&nbsp;&nbsp;예&nbsp;&nbsp;&nbsp;</button>
        <button id="confirmNoBtn">아니오</button>
    </div>
</div>

<!-- 진료 예약 모달 -->
<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentModal">&times;</span>
        <h3>진료 예약</h3>
        <div id="appointmentFormMessage" style="margin-bottom:10px; text-align:center;"></div>
        <form id="appointmentForm" th:action="@{/appointment}" method="post">
            <table>
                <tr>
                    <td><label for="patient_id">환자 ID:</label></td>
                    <td><input type="number" id="patient_id" name="patient_id" required></td>
                </tr>
                <tr>
                    <td><label for="staff_id">의료진 ID:</label></td>
                    <td><input type="number" id="staff_id" name="staff_id" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_date">예약 날짜:</label></td>
                    <td><input type="date" id="appointment_date" name="appointment_date" required></td>
                </tr>
                <tr>
                    <td><label for="appointment_time">예약 시간:</label></td>
                    <td><input type="time" id="appointment_time" name="appointment_time" required></td>
                </tr>
                <tr>
                    <td><input type="hidden" id="status" name="status" value="예약"></td>
                </tr>
                <tr>
                    <td><label for="remarks">메모:</label></td>
                    <td><input type="text" id="remarks" name="remarks" required></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: center; padding-top:10px;">
                        <button type="submit">예약 등록</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<!-- 예약 목록 모달 -->
<div id="appointmentListModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAppointmentListModal">&times;</span>
        <h3>진료 예약 목록</h3>
        <div id="appointmentListContainer"></div>
    </div>
</div>

<!-- 호출 모달 (간호사 페이지에서 호출 이벤트 발생 시 바로 띄움) -->
<div id="callModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeCallModal">&times;</span>
        <h3>호출된 환자 정보</h3>
        <div id="callPatientInfo">
            <!-- AJAX로 호출 환자 정보를 로드 -->
        </div>
        <button id="confirmCallBtn">확인</button>
        <button id="holdCallBtn">보류</button>
    </div>
</div>

<!-- 접수 모달 -->
<div id="receptionModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeReceptionModal">&times;</span>
        <h3>진료 접수</h3>

        <form id="receptionForm" action="/patient/register" method="post">
            <!-- 숨겨진/읽기전용 환자 ID -->
            <label for="patientId">환자 ID:</label>
            <input type="text" id="patientId" name="patientId" readonly />

            <!-- 의사 ID (직접 입력) -->
            <label for="doctorId">의사 ID:</label>
            <input type="number" id="doctorId" name="doctorId" />

            <!-- 진료 날짜/시간 -->
            <label for="visitDate">진료 날짜:</label>
            <input type="date" id="visitDate" name="visitDate" />
            <label for="visitTime">진료 시간:</label>
            <input type="time" id="visitTime" name="visitTime" />

            <!-- 진료 사유 -->
            <label for="visitReason">진료 사유:</label>
            <textarea id="visitReason" name="visitReason"></textarea>

            <!-- 방문 유형 -->
            <label for="visitType">방문 유형:</label>
            <select id="visitType" name="visitType">
                <option value="검진">검진</option>
                <option value="상담">상담</option>
                <option value="외래">외래</option>
                <option value="입원">입원</option>
                <option value="응급">응급</option>
                <option value="재진">재진</option>
                <option value="진료예약">진료예약</option>
                <option value="기타">기타</option>
            </select>

            <br><br>
            <button type="submit">접수 등록</button>
        </form>
        <div id="receptionFormMessage" style="margin-top: 10px; text-align: center;"></div>
    </div>
</div>

<!-- 스크립트 영역 -->
<script>
    // ----------------------
    // 기본 시간 및 채팅 기능
    // ----------------------
    function updateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
        const dayOfWeek = dayNames[now.getDay()];
        let hour = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = hour < 12 ? "오전" : "오후";
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour;
        const hourStr = String(hour).padStart(2, '0');
        document.getElementById("timeInfo").textContent = `${year}.${month}.${date} ${dayOfWeek} ${ampm} ${hourStr}:${minutes}:${seconds}`;
    }
    setInterval(updateTime, 1000);
    document.getElementById("chatButton").addEventListener("click", function(){
        alert("채팅 기능은 추후 구현 예정입니다!");
    });

    // ----------------------
    // 대기 환자 리스트 새로고침
    // ----------------------
    function refreshWaitingList() {
        fetch('/patient/waiting')
            .then(response => response.text())
            .then(html => { document.getElementById("patientList").innerHTML = html; })
            .catch(error => console.error("대기 리스트 오류:", error));
    }
    refreshWaitingList();
    setInterval(refreshWaitingList, 5000);

    // ----------------------
    // 정렬 기능
    // ----------------------
    function sortList() {
        const select = document.getElementById('sortSelect');
        const order = select.value;
        const list = document.getElementById('patientList');
        let items = Array.from(list.getElementsByTagName('li'));
        items.sort((a, b) => {
            return order === 'asc' ?
                a.textContent.trim().localeCompare(b.textContent.trim(), 'ko')
                : b.textContent.trim().localeCompare(a.textContent.trim(), 'ko');
        });
        list.innerHTML = "";
        items.forEach(item => list.appendChild(item));
    }


    // ----------------------
    // 접수 기능
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('register-btn')) {
            const patientId = e.target.getAttribute('data-id');
            // AJAX POST 요청: 환자 접수 처리
            fetch('/patient/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'patientId=' + encodeURIComponent(patientId)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // alert로 응답 메시지 표시
                    alert(data.message);
                    // 성공 시에만 모달 닫고 대기 리스트 갱신
                    if(data.success) {
                        document.getElementById("searchResultModal").style.display = "none";
                        refreshWaitingList();
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("환자 접수 중 오류 발생");
                });
        }
    });
    // 전역 변수에 삭제할 환자 ID 저장
    let deletePatientId = null;
    // 삭제 버튼 클릭 이벤트 처리 (대기 리스트 내)
    document.getElementById('patientList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-btn')) {
            deletePatientId = e.target.getAttribute('data-id');
            // 확인 모달 열기
            document.getElementById("confirmModal").style.display = "block";
        }
    });
    // 확인 모달 닫기 처리
    document.getElementById("closeConfirmModal").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
    };

    // "아니오" 버튼 처리
    document.getElementById("confirmNoBtn").onclick = function() {
        document.getElementById("confirmModal").style.display = "none";
        deletePatientId = null;
    };

    // "예" 버튼 처리: 실제로 환자 삭제 (대기 리스트에서 제거)
    document.getElementById("confirmYesBtn").onclick = function() {
        if (!deletePatientId) return;
        fetch('/patient/waiting/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'patientId=' + encodeURIComponent(deletePatientId)
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("대기 리스트에서 제거되었습니다.");
                    refreshWaitingList();
                    // ── 여기에 MedicalVisit 레코드 삭제 요청 추가 ──
                    return fetch('/medicalvisit/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ patientId: deletePatientId })
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(res2 => res2.json())
            .then(json2 => {
                if (json2.success) {
                    console.log('MedicalVisit 최신 레코드 삭제 완료');
                } else {
                    console.warn('MedicalVisit 삭제 실패:', json2.message);
                }
            })
            .catch(err => {
                console.error("취소 처리 중 오류:", err);
                alert("대기열 취소 처리 중 오류가 발생하였습니다.");
            })
            .finally(() => {
                deletePatientId = null;
                document.getElementById("confirmModal").style.display = "none";
            });
    };

    setInterval(() => {
        refreshWaitingList();
    }, 5000); // 5초

    function refreshStats() {
        fetch('/patient/stats')
            .then(response => {
                if (!response.ok) throw new Error("네트워크 응답 오류");
                return response.json();
            })
            .then(data => {
                document.getElementById('waitingCount').innerText = data.waitingCount + "명";
                document.getElementById('collectionCount').innerText = data.collectionCount + "명";
            })
            .catch(error => {
                console.error("Stats refresh error:", error);
            });
    }

    // 페이지 로드 시 및 5초 간격으로 업데이트
    refreshStats();
    setInterval(refreshStats, 5000);


    // ----------------------
    // 호출 모달 기능 (간호사 페이지)
    // ----------------------
    window.addEventListener("storage", function(event) {
        if (event.key === "callPatient" && event.newValue) {
            try {
                const callInfo = JSON.parse(event.newValue);
                const patientId = callInfo.patientId;
                if (!patientId) return;
                fetch('/patient/call?patientId=' + encodeURIComponent(patientId))
                    .then(response => response.json())
                    .then(patient => {
                        document.getElementById("callPatientInfo").innerHTML = `
            <p><strong>이름:</strong> ${patient.name}</p>
            <p><strong>생년월일:</strong> ${patient.date_of_birth}</p>
            <p><strong>전화번호:</strong> ${patient.phone_number}</p>
            <p><strong>이메일:</strong> ${patient.email}</p>
            <p><strong>주소:</strong> ${patient.address}</p>
          `;
                        document.getElementById("callModal").dataset.patientId = patientId;
                        document.getElementById("callModal").style.display = "block";
                    })
                    .catch(error => console.error("호출 환자 정보 로드 실패:", error));
            } catch(e) {
                console.error("호출 이벤트 파싱 오류:", e);
            }
        }
    });
    document.getElementById("closeCallModal").onclick = function() {
        document.getElementById("callModal").style.display = "none";
    };

    // 호출 모달 "확인" 버튼 (nurse 페이지)
    document.getElementById("confirmCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        // 백엔드에서 환자의 상태를 '진료중' (called = true)로 업데이트하도록 함
        fetch('/patient/call/confirm', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                // 대기 리스트는 즉시 제거하지 않고, 나중에 의사 페이지에서 버튼 상태에 따라 업데이트됨
                // (예: 주기적 새로고침 시 환자의 called 플래그가 true로 반영됨)
            })
            .catch(error => {
                console.error("호출 확인 실패:", error);
                alert("호출 확인에 실패하였습니다.");
            });
    });

    // 호출 모달 "보류" 버튼 처리
    document.getElementById("holdCallBtn").addEventListener("click", function(){
        const patientId = document.getElementById("callModal").dataset.patientId;
        if (!patientId) return;
        fetch('/patient/call/hold', {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "patientId=" + encodeURIComponent(patientId)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById("callModal").style.display = "none";
                refreshWaitingList();
            })
            .catch(error => {
                console.error("보류 처리 실패:", error);
                alert("보류 처리에 실패하였습니다.");
            });
    });

    // ----------------------
    // 환자 검색 결과 모달 처리
    // ----------------------
    const searchBar = document.getElementById("topSearchBar");
    searchBar.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const keyword = searchBar.value.trim();
            if (!keyword) {
                alert("검색어를 입력하세요.");
                return;
            }
            fetch(`/patient/search?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("searchResultContainer").innerHTML = html;
                    document.getElementById("searchResultModal").style.display = "block";
                })
                .catch(error => {
                    console.error("검색 실패:", error);
                    alert("검색 결과를 불러오는데 실패했습니다.");
                });
        }
    });
    const searchResultModal = document.getElementById("searchResultModal");
    const closeSearchModal = document.getElementById("closeSearchModal");
    closeSearchModal.onclick = function() {
        searchResultModal.style.display = "none";
    };
    window.onclick = function(event) {
        if (event.target === searchResultModal) {
            searchResultModal.style.display = "none";
        }
    };

    // ----------------------
    // 예약 모달 처리
    // ----------------------
    document.getElementById('searchResultContainer').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('appointment-btn')) {
            const patientId = e.target.getAttribute('data-id');
            if (!patientId) {
                alert("환자 ID가 누락되었습니다.");
                return;
            }
            document.getElementById('patient_id').value = patientId;
            document.getElementById('appointmentModal').style.display = "block";
        }
    });
    const appointmentModal = document.getElementById("appointmentModal");
    const closeAppointmentModalBtn = document.getElementById("closeAppointmentModal");
    closeAppointmentModalBtn.onclick = function() {
        appointmentModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentModal) {
            appointmentModal.style.display = "none";
        }
    });
    const appointmentForm = document.getElementById("appointmentForm");
    const appointmentFormMessage = document.getElementById("appointmentFormMessage");
    appointmentForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(appointmentForm);
        fetch(appointmentForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("네트워크 오류");
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    appointmentFormMessage.style.color = "green";
                    appointmentFormMessage.textContent = data.message;
                    setTimeout(() => {
                        appointmentModal.style.display = "none";
                        appointmentForm.reset();
                        appointmentFormMessage.textContent = "";
                    }, 1500);
                } else {
                    appointmentFormMessage.style.color = "red";
                    appointmentFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("예약 등록 중 오류:", error);
                appointmentFormMessage.style.color = "red";
                appointmentFormMessage.textContent = "예약 등록에 실패하였습니다.";
            });
    });

    // 예약 목록 모달 처리
    const openAppointmentListModalBtn = document.getElementById("openAppointmentListModalBtn");
    const appointmentListModal = document.getElementById("appointmentListModal");
    const closeAppointmentListModalBtn = document.getElementById("closeAppointmentListModal");
    openAppointmentListModalBtn.onclick = function() {
        fetch('/appointment/list')
            .then(response => {
                if (!response.ok) throw new Error("네트워크 응답 오류");
                return response.text();
            })
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
                appointmentListModal.style.display = "block";
            })
            .catch(error => {
                console.error("예약 목록 불러오기 실패:", error);
                alert("예약 목록을 불러오는데 실패했습니다.");
            });
    };
    closeAppointmentListModalBtn.onclick = function() {
        appointmentListModal.style.display = "none";
    };
    window.addEventListener('click', function(event) {
        if (event.target === appointmentListModal) {
            appointmentListModal.style.display = "none";
        }
    });

    // ----------------------
    // 캘린더 이벤트 (일정 추가) – 클라이언트 사이드 처리
    // ----------------------
    (function(){
        let events = {}; // { "YYYY-MM-DD": [{ title: "회의", desc: "내용" }, ...] }
        function renderEventCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month+1, 0).getDate();
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = "";
            let row = document.createElement('tr');
            let cellCount = 0;
            for(let i=0; i<firstDay; i++){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            for(let d=1; d<=lastDate; d++){
                let cell = document.createElement('td');
                let btn = document.createElement('button');
                btn.className = 'day-btn';
                btn.textContent = d;
                let dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(events[dateKey] && events[dateKey].length > 0){
                    btn.classList.add('has-event');
                }
                btn.addEventListener('click', function(){
                    openEventModal(dateKey);
                });
                cell.appendChild(btn);
                row.appendChild(cell);
                cellCount++;
                if(cellCount % 7 === 0){
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                }
            }
            while(cellCount % 7 !== 0){
                let cell = document.createElement('td');
                row.appendChild(cell);
                cellCount++;
            }
            calendarBody.appendChild(row);
        }
        function refreshEventList() {
            const eventListElem = document.getElementById("eventList");
            eventListElem.innerHTML = "";
            const currentMonthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2, '0')}`;
            for(let dateKey in events){
                if(dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0){
                    let li = document.createElement('li');
                    li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                    eventListElem.appendChild(li);
                }
            }
        }
        const eventModal = document.getElementById("eventModal");
        const closeEventModalBtn = document.getElementById("closeEventModal");
        const modalDateDisplay = document.getElementById("modalDateDisplay");
        let selectedDateKey = "";
        function openEventModal(dateKey) {
            selectedDateKey = dateKey;
            modalDateDisplay.textContent = "날짜: " + dateKey;
            eventModal.style.display = "block";
        }
        closeEventModalBtn.onclick = function(){
            eventModal.style.display = "none";
        };
        window.addEventListener('click', function(event){
            if(event.target === eventModal){
                eventModal.style.display = "none";
            }
        });
        document.getElementById("eventForm").addEventListener("submit", function(e){
            e.preventDefault();
            const title = document.getElementById("eventTitle").value.trim();
            const desc = document.getElementById("eventDesc").value.trim();
            if(!title){
                alert("제목을 입력하세요.");
                return;
            }
            if(!events[selectedDateKey]){
                events[selectedDateKey] = [];
            }
            events[selectedDateKey].push({ title: title, desc: desc });
            eventModal.style.display = "none";
            document.getElementById("eventForm").reset();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()-1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth()+1);
            updateCalendarBanner();
            renderEventCalendar();
            refreshEventList();
        });
        updateCalendarBanner();
        renderEventCalendar();
        refreshEventList();
    })();

</script>
<!-- 접수 모달 처리 -->
<script>
    function openReceptionModal(patientId) {
        document.getElementById("patientId").value = patientId;
        let now = new Date();
        document.getElementById("visitDate").valueAsDate = now;
        let hh = String(now.getHours()).padStart(2, '0');
        let mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById("visitTime").value = hh + ":" + mm;
        document.getElementById("receptionModal").style.display = "block";
    }

    document.getElementById("closeReceptionModal").onclick = function() {
        document.getElementById("receptionModal").style.display = "none";
    };

    const receptionForm = document.getElementById("receptionForm");
    const receptionFormMessage = document.getElementById("receptionFormMessage");
    receptionForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(receptionForm);

        fetch(receptionForm.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    receptionFormMessage.style.color = "green";
                    receptionFormMessage.textContent = data.message;
                    setTimeout(() => {
                        document.getElementById("receptionModal").style.display = "none";
                        receptionForm.reset();
                        receptionFormMessage.textContent = "";
                        refreshWaitingList();
                    }, 1000);
                } else {
                    receptionFormMessage.style.color = "red";
                    receptionFormMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("접수 등록 실패:", error);
                receptionFormMessage.style.color = "red";
                receptionFormMessage.textContent = "등록 중 오류 발생";
            });
    });

    // 접수 모달에서 폼 제출 시 처리
    document.getElementById("receptionForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(document.getElementById("receptionForm"));

        // 먼저 /patient/register API 호출 (환자 대기 상태 업데이트)
        fetch('/patient/register', {
            method: "POST",
            body: new URLSearchParams({ patientId: formData.get("patientId") })
        })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // 환자 접수가 성공하면, 진료 접수 정보를 등록하기 위해 /medicalvisit/create 호출
                    return fetch('/medicalvisit/create', {
                        method: "POST",
                        body: new URLSearchParams({
                            patientId: formData.get("patientId"),
                            doctorId: formData.get("doctorId"),
                            visitDate: formData.get("visitDate"),
                            visitTime: formData.get("visitTime"),
                            visitReason: formData.get("visitReason"),
                            visitType: formData.get("visitType")
                        })
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert("진료 접수 등록 성공");
                    document.getElementById("receptionModal").style.display = "none";
                    // 필요시 대기 리스트 새로고침 등 추가 작업
                } else {
                    alert("진료 접수 등록 실패: " + data.message);
                }
            })
            .catch(error => {
                console.error("접수 처리 중 오류:", error);
                alert("접수 처리 중 오류가 발생하였습니다.");
            });
    });
</script>
<script>
    document.getElementById("openModalBtn").addEventListener("click", function() {
        document.getElementById("patientModal").style.display = "block";
    });
    document.getElementById("closePatientModal").onclick = function() {
        document.getElementById("patientModal").style.display = "none";
    };
    document.getElementById("patientForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                const formMessage = document.getElementById("formMessage");
                if (data.success) {
                    formMessage.style.color = "green";
                    formMessage.textContent = data.message;
                    // 1.5초 후에 모달창 닫고 폼 리셋
                    setTimeout(() => {
                        document.getElementById("patientModal").style.display = "none";
                        form.reset();
                        formMessage.textContent = "";
                    }, 1500);
                } else {
                    formMessage.style.color = "red";
                    formMessage.textContent = data.message;
                }
            })
            .catch(error => {
                console.error("환자 등록 중 오류 발생:", error);
                const formMessage = document.getElementById("formMessage");
                formMessage.style.color = "red";
                formMessage.textContent = "환자 등록 중 오류 발생";
            });
    });
</script>

<script>
    // 전역 변수: 이벤트 정보를 저장할 객체 (예: { "2025-03-15": [ { eventId: 1, title:"회의", description:"내용" }, ... ] })
    var events = {};

    // 현재 달력 기준 날짜 (월 단위)
    var currentDate = new Date();
    currentDate.setDate(1);

    // 선택한 날짜 (YYYY-MM-DD)
    var selectedDateKey = "";

    // 현재 사용할 역할
    var calendarRole = "nurse";

    // 캘린더 배너 업데이트
    function updateCalendarBanner() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var monthStr = String(month + 1).padStart(2, '0');
        document.getElementById("calendarMonth").textContent = `${year}.${monthStr}`;
        var today = new Date();
        var tYear = today.getFullYear();
        var tMonth = String(today.getMonth() + 1).padStart(2, '0');
        var tDate = String(today.getDate()).padStart(2, '0');
        document.getElementById("todayDate").textContent = `오늘: ${tYear}.${tMonth}.${tDate}`;
    }

    // 캘린더 렌더링: 날짜 버튼 생성
    function renderCalendar() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var firstDay = new Date(year, month, 1).getDay();
        var lastDate = new Date(year, month + 1, 0).getDate();
        var calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = "";
        var row = document.createElement("tr");
        var cellCount = 0;

        // 이전 달 빈 셀
        for (var i = 0; i < firstDay; i++) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }

        // 현재 달 날짜 버튼 생성
        for (var d = 1; d <= lastDate; d++) {
            var cell = document.createElement("td");
            var btn = document.createElement("button");
            btn.className = "day-btn";
            btn.textContent = d;
            var fullDate = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            btn.setAttribute("data-date", fullDate);
            // 오늘 날짜 강조
            var today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                btn.classList.add("today");
            }
            btn.addEventListener("click", function() {
                openEventModal(this.getAttribute("data-date"));
            });
            cell.appendChild(btn);
            row.appendChild(cell);
            cellCount++;
            if (cellCount % 7 === 0) {
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }

        // 남은 셀 채우기
        while (cellCount % 7 !== 0) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        calendarBody.appendChild(row);
    }

    // 월간 이벤트 목록 갱신 (서버에서 조회하여 events 객체 업데이트 후 화면 갱신)
    function refreshMonthlyEventList() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1;
        // AJAX 요청: /calendar/{role}/events?year=YYYY&month=MM
        fetch(`/calendar/${calendarRole}/events?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                // data는 CalendarEvent 객체 배열입니다.
                // 이벤트를 날짜별로 분류하여 events 전역 객체에 저장
                events = {};  // 초기화
                data.forEach(function(ev) {
                    var key = ev.eventDate;
                    if (!events[key]) {
                        events[key] = [];
                    }
                    events[key].push(ev);
                });
                // 하단 월간 이벤트 목록 갱신
                var listElem = document.getElementById("eventList");
                listElem.innerHTML = "";
                var currentMonthPrefix = `${year}-${String(month).padStart(2,'0')}`;
                for (var dateKey in events) {
                    if (dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0) {
                        var li = document.createElement("li");
                        li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                        listElem.appendChild(li);
                    }
                }
            })
            .catch(error => {
                console.error("월간 이벤트 조회 오류:", error);
            });
    }

    // 모달 열기: 해당 날짜의 기존 일정 목록을 로드 및 모달 폼 초기화
    function openEventModal(dateKey) {
        selectedDateKey = dateKey;
        document.getElementById("selectedDateDisplay").textContent = dateKey;

        var existingEventsDiv = document.getElementById("existingEvents");
        if (events[dateKey] && events[dateKey].length > 0) {
            renderExistingEvents(dateKey, events[dateKey]);
        } else {
            existingEventsDiv.innerHTML = "<em style='color:#999;'>일정 없음</em>";
        }

        // 모달 폼 초기화: 이전 수정 정보 삭제
        document.getElementById("eventTitleInput").value = "";
        document.getElementById("eventDescInput").value = "";
        document.getElementById("eventIdInput").value = "";
        document.getElementById("calendarEventModalTitle").textContent = "일정 추가";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // renderExistingEvents: 선택한 날짜의 이벤트 목록을 렌더링 (수정/삭제 버튼 포함)
    function renderExistingEvents(dateKey, eventsForDate) {
        const container = document.getElementById("existingEvents");
        container.innerHTML = "";
        if (eventsForDate && eventsForDate.length > 0) {
            eventsForDate.forEach(event => {
                const eventDiv = document.createElement("div");
                eventDiv.style.display = "flex";
                eventDiv.style.justifyContent = "space-between";
                eventDiv.style.alignItems = "center";
                eventDiv.style.marginBottom = "4px";

                // 이벤트 제목과 설명 표시
                const infoSpan = document.createElement("span");
                infoSpan.textContent = `${event.title} - ${event.description}`;
                eventDiv.appendChild(infoSpan);

                // 버튼 래퍼를 생성하고 flex 설정 (gap을 0으로)
                const btnWrapper = document.createElement("div");
                btnWrapper.style.display = "flex";
                btnWrapper.style.gap = "0px";  // 버튼들 사이 여백 0

                // 수정 버튼 생성 (여기서는 margin을 제거)
                const editBtn = document.createElement("button");
                editBtn.textContent = "수정";
                editBtn.style.marginLeft = "0px";  // margin 제거
                editBtn.addEventListener("click", function() {
                    openEventModalForEdit(dateKey, event);
                });
                btnWrapper.appendChild(editBtn);

                // 삭제 버튼 생성 (여기도 margin 제거)
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "삭제";
                deleteBtn.style.marginLeft = "0px";  // margin 제거
                deleteBtn.addEventListener("click", function() {
                    deleteCalendarEvent(dateKey, event.eventId);
                });
                btnWrapper.appendChild(deleteBtn);

                // 버튼 래퍼를 오른쪽에 붙여넣기
                eventDiv.appendChild(btnWrapper);
                container.appendChild(eventDiv);
            });
        } else {
            container.innerHTML = "<em style='color:#999;'>일정 없음</em>";
        }
    }

    // 수정 모달: 기존 이벤트 데이터를 폼에 로드
    function openEventModalForEdit(dateKey, event) {
        document.getElementById("selectedDateDisplay").textContent = dateKey;
        document.getElementById("eventTitleInput").value = event.title;
        document.getElementById("eventDescInput").value = event.description;
        document.getElementById("eventIdInput").value = event.eventId;
        document.getElementById("calendarEventModalTitle").textContent = "일정 수정";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // 삭제 처리: 백엔드 삭제 API 호출 후 이벤트 목록 갱신
    function deleteCalendarEvent(dateKey, eventId) {
        if (confirm("해당 일정을 삭제하시겠습니까?")) {
            fetch(`/calendar/delete?eventId=${eventId}`, {
                method: "POST"
            })
                .then(response => response.json())
                .then(function(data) {
                    if (data.success) {
                        alert("일정이 삭제되었습니다.");
                        if (events[dateKey]) {
                            events[dateKey] = events[dateKey].filter(ev => ev.eventId !== eventId);
                            renderExistingEvents(dateKey, events[dateKey]);
                        }
                        refreshMonthlyEventList();
                    } else {
                        alert("삭제 실패: " + data.message);
                    }
                })
                .catch(function(error) {
                    console.error("삭제 요청 오류:", error);
                    alert("삭제 처리 중 오류가 발생하였습니다.");
                });
        }
    }

    // 모달 폼 제출: 신규 생성 또는 수정 작업 처리
    document.getElementById("calendarEventForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var dateStr = document.getElementById("selectedDateDisplay").textContent;
        var title = document.getElementById("eventTitleInput").value.trim();
        var desc = document.getElementById("eventDescInput").value.trim();
        var eventId = document.getElementById("eventIdInput").value.trim(); // 수정 시 값 존재

        if (!title) {
            alert("제목을 입력하세요.");
            return;
        }

        var url = `/calendar/${calendarRole}/save?eventDate=${encodeURIComponent(dateStr)}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(desc)}`;
        if (eventId) {
            url += `&eventId=${encodeURIComponent(eventId)}`;
        }

        fetch(url, { method: "POST" })
            .then(response => response.json())
            .then(function(data) {
                alert(data.message);
                document.getElementById("calendarEventModal").style.display = "none";
                // 새로 저장된 이벤트를 갱신하기 위해 리프레시
                refreshMonthlyEventList();
                renderCalendar();
            })
            .catch(function(error) {
                console.error("저장 오류:", error);
                alert("일정 저장 중 오류 발생");
            });
    });

    // 이전/다음 달 버튼 처리
    document.getElementById("prevMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });
    document.getElementById("nextMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });

    // 초기 실행
    updateCalendarBanner();
    renderCalendar();
    refreshMonthlyEventList();

    document.getElementById("closeCalendarEventModal").onclick = function() {
        document.getElementById("calendarEventModal").style.display = "none";
    };

    document.getElementById("calendarEventModal").addEventListener("click", function(event) {
        if (event.target === this) {
            this.style.display = "none";
        }
    });


</script>
<script>
    // 예약 목록에 있는 "접수" 및 "취소" 버튼 클릭 이벤트 처리
    document.addEventListener("click", function(e) {
        // "접수" 버튼 클릭 시
        if (e.target && e.target.classList.contains("reception-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            var patientId = e.target.getAttribute("data-patient-id");
            if (!appointmentId || !patientId) return;
            if (confirm("이 예약을 접수 처리하시겠습니까? (상태가 '완료'로 업데이트되고 환자 대기 리스트로 등록됩니다)")) {
                // 첫 번째: 예약 상태를 '완료'로 업데이트
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=완료`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 두 번째: patient 테이블의 waiting 값을 true로 업데이트 (/patient/register 엔드포인트 활용)
                            return fetch(`/patient/register?patientId=${patientId}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" }
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .then(response => response.json())
                    .then(function(data2) {
                        alert("접수 처리 완료: " + data2.message);
                        // 예약 목록 및 대기 환자 리스트 갱신
                        refreshAppointmentList();
                        refreshWaitingList();  // 이 함수는 대기 환자 리스트를 새로고침하는 함수를 구현해야 합니다.
                    })
                    .catch(function(error) {
                        console.error("접수 처리 오류:", error);
                        alert("예약 접수 및 대기 등록 처리 중 오류가 발생하였습니다.");
                    });
            }
        }
        // "취소" 버튼 클릭 시
        else if (e.target && e.target.classList.contains("cancel-btn")) {
            var appointmentId = e.target.getAttribute("data-id");
            if (confirm("이 예약을 취소하시겠습니까?")) {
                fetch(`/appointment/updateStatus?appointmentId=${appointmentId}&status=취소`, {
                    method: "POST"
                })
                    .then(response => response.json())
                    .then(function(data) {
                        alert(data.message);
                        refreshAppointmentList();
                    })
                    .catch(function(error) {
                        console.error("취소 처리 오류:", error);
                        alert("예약 취소 처리 중 오류가 발생하였습니다.");
                    });
            }
        }
    });

    // 예약 목록을 새로고침하는 함수 (AJAX로 예약 목록 fragment 재로딩)
    function refreshAppointmentList() {
        fetch('/appointment/list')
            .then(response => response.text())
            .then(html => {
                document.getElementById("appointmentListContainer").innerHTML = html;
            })
            .catch(function(error) {
                console.error("예약 목록 갱신 오류:", error);
            });
    }

    // 예시: 대기 환자 리스트를 새로고침하는 함수 (별도로 구현)
    function refreshWaitingList() {
        fetch('/patient/doctor/waiting')
            .then(response => response.text())
            .then(html => {
                document.getElementById("doctorPatientList").innerHTML = html;
            })
            .catch(function(error) {
                console.error("대기 리스트 갱신 오류:", error);
            });
    }

</script>
</body>
</html>