<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이비인후과 EMR - 의사 메인화면</title>
    <link rel="stylesheet" th:href="@{/css/doctor_style.css}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
<div class="header">
    <div class="left-section">
        <span class="greeting">반갑습니다. 홍길동 님</span>
        <button>오늘의 현황</button>
        <button>진료실</button>
    </div>

    <div class="center-section">
        <input class="search-bar" type="text" placeholder="환자검색/이름/환자등록번호/생년월일/휴대폰번호">
    </div>

    <div class="right-section">
        <span class="time-info" id="timeInfo">00:00:00</span>
        <button class="chat-button" id="chatButton">&#128172;</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="profile-banner">
            <div class="profile-top">
                <img src="https://via.placeholder.com/40" alt="Profile Picture" class="profile-pic">
                <div class="profile-name">홍길동(의사)</div>
            </div>
            <div class="profile-stats">
                <span class="status-label">대기</span>
                <span id="waitingCount" class="status-number">0명</span>
                <span class="status-separator">|</span>
                <span class="status-label">오늘 수납</span>
                <span id="collectionCount" class="status-number">0명</span>
            </div>
        </div>

        <div class="waiting-patient-list">
            <div class="list-header">
                <h3>접수 대기 환자 리스트</h3>
            </div>
            <div class="list-container" id="doctorPatientList">
                <!-- /doctor/waiting 엔드포인트에서 반환한 프래그먼트가 여기로 로드됨 -->
            </div>
        </div>
    </div>


    <!-- 메인 콘텐츠 영역 -->
    <div class="main-content">
        <div class="row half-row first-content">
            <div class="column left-column">
                <div class="patient-card">
                    <div class="patient-info">
                        <h3>환자 정보</h3>
                        <p><strong>이름:</strong> <span id="patientName">--</span></p>
                        <p><strong>나이:</strong> <span id="patientAge">--</span></p>
                        <p><strong>성별:</strong> <span id="patientGender">--</span></p>
                        <p><strong>전화번호:</strong> <span id="patientPhone">--</span></p>
                        <p><strong>접수 메모:</strong> <span id="receptionMemo">--</span></p>
                    </div>
                    <div class="patient-memo">
                        <h4>진료 메모</h4>
                        <textarea id="clinicalMemo" placeholder="환자 관련 메모를 작성하세요."></textarea>
                    </div>
                </div>
            </div>
            <div class="column right-column">
                <div class="record-card">
                    <div class="toolbar">
                        <button type="button" onclick="formatText('bold')"><strong>B</strong></button>
                        <button type="button" onclick="formatText('italic')"><em>I</em></button>
                        <button type="button" onclick="formatText('underline')"><u>U</u></button>
                        <select id="fontSizeSelect" onchange="changeFontSize(this.value)">
                            <option value="10">10px</option>
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16">16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="22">22px</option>
                            <option value="24">24px</option>
                            <option value="26">26px</option>
                            <option value="28">28px</option>
                        </select>
                    </div>
                    <div id="recordEditor" class="editor" contenteditable="true" placeholder="진료 기록을 작성하세요."></div>
                </div>
            </div>
        </div>
        <!-- 검사 결과 섹션 -->
        <div class="examination-section">
            <h4>검사 결과</h4>
            <table class="examination-table styled-table">
                <thead>
                <tr>
                    <th style="width:15%;">검사 일자</th>
                    <th style="width:25%;">검사 종류</th>
                    <th style="width:40%;">결과 요약</th>
                    <th style="width:20%;">첨부 이미지</th>
                    <th style="width:5%;">X</th>
                </tr>
                </thead>
                <tbody id="examinationTbody">
                <!-- JS 로 동적으로 추가되는 행들 -->
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="5" style="text-align:right">
                        <button type="button" id="addExaminationRowBtn">+ 추가</button>
                    </td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="row half-row middle-content">
            <div class="column left-column">
                <!-- 진단 목록 섹션 -->
                <div class="diagnosis-form-container">
                    <h4>진단 리스트</h4>
                    <table id="diagnosisTable">
                        <thead>
                        <tr>
                            <th style="width:15%;">진단 코드</th>
                            <th style="width:50%;">진단 명</th>
                            <th style="width:20%;">진료과</th>
                            <th style="width:5%;">X</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 진단 행이 동적으로 추가됨 -->
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="4">
                                <button type="button" id="addDiagnosisRowBtn">+ 추가</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
                <!-- 처방 섹션 -->
                <div class="prescription-section">
                    <h4>처방</h4>
                    <table id="prescriptionTable">
                        <thead>
                        <tr>
                            <th style="width:15%;">코드</th>
                            <th>명칭</th>
                            <th style="width:10%;">용량</th>
                            <th style="width:10%;">일수</th>
                            <th style="width:10%;">횟수</th>
                            <th style="width:12%;">급여</th>
                            <th style="width:10%;">시간</th>
                            <th>X</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 동적으로 처방 행 추가 -->
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="8">
                                <button type="button" id="addPrescriptionRowBtn">+ 추가</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="column right-column">
                <div class="row full-row">
                    <div class="treatmentplan-form-container">
                        <h3>치료 계획 입력</h3>
                        <div class="treatmentplan-grid">
                            <label for="treatmentDescription">치료 내용</label>
                            <textarea id="treatmentDescription" rows="2" placeholder="치료 내용..."></textarea>

                            <label for="startDate">시작 일자</label>
                            <input type="date" id="startDate" />

                            <label for="endDate">종료 일자</label>
                            <input type="date" id="endDate" />

                            <label>상태</label>
                            <div id="treatmentStatusRadios">
                                <label><input class="treatmentStatus" type="radio" name="treatmentStatus" value="예정" checked> 예정</label>
                                <label><input class="treatmentStatus" type="radio" name="treatmentStatus" value="진행중"> 진행중</label>
                                <label><input class="treatmentStatus" type="radio" name="treatmentStatus" value="완료"> 완료</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 진료 완료 버튼 -->
        <button type="button" id="completeVisitBtn" style="padding:8px 12px;">진료 완료</button>

        <!-- 역대 진료 기록 섹션 -->
        <div class="history-container" style="display: flex; gap: 10px;">
            <div class="visit-history-list">
                <ul id="visitHistoryList" style="width: 180px; border: 1px solid #ccc; background: #fff;">
                    <!-- 역대 진료 기록 날짜 목록이 동적으로 추가됩니다. -->
                </ul>
            </div>
            <div class="visit-history-detail" style="flex: 1; border: 1px solid #ccc; padding: 10px; background: #fff;">
                <h4>진료 날짜: <span id="historyVisitDate">-</span> <span id="historyVisitTime"></span></h4>
                <div>
                    <strong>진료 사유:</strong>
                    <div id="historyReasonSection"></div>
                </div>
                <div>
                    <strong>진료 메모:</strong>
                    <div id="historyMemoSection"></div>
                </div>
                <div style="margin-top:10px;">
                    <strong>진료 기록:</strong>
                    <div id="historyNotesSection" class="record-html"></div>
                </div>
                <div style="margin-top:20px;">
                    <strong>검사 결과:</strong>
                    <div id="historyExamSummary" style="margin:5px 0;"></div>
                    <div id="examImagesCarousel" style="display:flex; align-items:center; gap:8px;">
                        <button id="examPrevBtn" type="button" style="font-size:1.2rem;" disabled>&lt;</button>
                        <div id="examImagesContainer" style="display:flex; gap:8px; flex:1; justify-content:center;"></div>
                        <button id="examNextBtn" type="button" style="font-size:1.2rem;" disabled>&gt;</button>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <strong>과거 진단:</strong>
                    <ul id="historyDiagnosisList" style="margin:5px 0; padding-left:20px;"></ul>
                </div>
                <div style="margin-top:20px;">
                    <strong>처방 내역:</strong>
                    <table id="historyPrescriptionTable" style="width:100%; border-collapse: collapse; margin-top:4px;">
                        <thead>
                        <tr style="background: #eee;">
                            <th style="width:15%;">코드</th>
                            <th style="width:30%;">명칭</th>
                            <th style="width:15%;">용량</th>
                            <th style="width:15%;">일수</th>
                            <th style="width:15%;">횟수</th>
                            <th style="width:15%;">급여</th>
                        </tr>
                        </thead>
                        <tbody id="historyPrescriptionTbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 우측 배너: 캘린더 영역 (일정관리 모달 포함) -->
    <div class="right-banner">
        <div class="calendar-banner">
            <button id="prevMonthBtn" title="이전 달">&#9664;</button>
            <span id="calendarMonth">2025.03</span>
            <button id="nextMonthBtn" title="다음 달">&#9654;</button>
            <div class="today-date" id="todayDate">오늘: 2025.03.13</div>
        </div>
        <table class="month-view" id="calendarTable">
            <thead>
            <tr>
                <th>일</th>
                <th>월</th>
                <th>화</th>
                <th>수</th>
                <th>목</th>
                <th>금</th>
                <th>토</th>
            </tr>
            </thead>
            <tbody id="calendarBody">
            <!-- 날짜 버튼이 JavaScript로 생성됨 -->
            </tbody>
        </table>
        <div id="monthEventList">
            <h3>이번 달 일정</h3>
            <ul id="eventList" style="list-style: none; padding: 0;"></ul>
        </div>

        <!-- 일정 추가/수정 모달 -->
        <div id="calendarEventModal" class="modal" style="display:none;">
            <div class="modal-content" style="background:#fff; padding:20px; border-radius:4px; width:300px; margin:100px auto; position:relative;">
                <span class="close" id="closeCalendarEventModal" style="position:absolute; top:8px; right:12px; cursor:pointer;">&times;</span>
                <h3 id="calendarEventModalTitle">일정 관리</h3>
                <!-- 선택한 날짜 표시 -->
                <p id="selectedDateDisplay" style="font-weight: bold;"></p>
                <!-- 기존 일정 목록 -->
                <div id="existingEvents" style="max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px; font-size:0.9rem;">
                    <em style="color:#999;">해당 날짜에 등록된 일정 없음</em>
                </div>
                <!-- 숨은 eventId 입력 -->
                <input type="hidden" id="eventIdInput" name="eventId" value="">
                <!-- 새 일정/수정 폼 -->
                <form id="calendarEventForm">
                    <div>
                        <label for="eventTitleInput">제목:</label><br>
                        <input type="text" id="eventTitleInput" name="eventTitle" required style="width:100%; box-sizing:border-box;">
                    </div>
                    <div style="margin-top:8px;">
                        <label for="eventDescInput">내용:</label><br>
                        <textarea id="eventDescInput" name="eventDesc" style="width:100%; box-sizing:border-box;"></textarea>
                    </div>
                    <div style="margin-top:12px; text-align:right;">
                        <button type="submit">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function updateTime() {
        const now = new Date();

        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');

        const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
        const dayOfWeek = dayNames[now.getDay()];

        let hour = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const ampm = hour < 12 ? "오전" : "오후";
        hour = hour % 12;
        hour = hour === 0 ? 12 : hour;
        const hourStr = String(hour).padStart(2, '0');

        const timeString = `${year}.${month}.${date} ${dayOfWeek} ${ampm} ${hourStr}:${minutes}:${seconds}`;

        document.getElementById('timeInfo').textContent = timeString;
    }

    setInterval(updateTime, 1000);

    // 채팅 버튼 클릭 이벤트 (예시)
    document.getElementById('chatButton').addEventListener('click', function() {
        alert("채팅 기능은 추후 구현 예정입니다!");
    });

    function sortList() {
        const select = document.getElementById('sortSelect');
        const order = select.value; // 'asc' or 'desc'
        const list = document.getElementById('patientList');
        // li 요소들을 배열로 변환
        let items = Array.from(list.getElementsByTagName('li'));

        items.sort((a, b) => {
            const nameA = a.textContent.trim();
            const nameB = b.textContent.trim();
            return order === 'asc'
                ? nameA.localeCompare(nameB, 'ko')
                : nameB.localeCompare(nameA, 'ko');
        });

        list.innerHTML = "";
        items.forEach(item => list.appendChild(item));
    }
</script>
<script>
    // 전역 변수: 이벤트 정보를 저장할 객체 (예: { "2025-03-15": [ { eventId: 1, title:"회의", description:"내용" }, ... ] })
    var events = {};

    // 현재 달력 기준 날짜 (월 단위)
    var currentDate = new Date();
    currentDate.setDate(1);

    // 선택한 날짜 (YYYY-MM-DD)
    var selectedDateKey = "";

    // 현재 사용할 역할 (doctor, nurse 등)
    var calendarRole = "doctor";

    // 캘린더 배너 업데이트
    function updateCalendarBanner() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var monthStr = String(month + 1).padStart(2, '0');
        document.getElementById("calendarMonth").textContent = `${year}.${monthStr}`;
        var today = new Date();
        var tYear = today.getFullYear();
        var tMonth = String(today.getMonth() + 1).padStart(2, '0');
        var tDate = String(today.getDate()).padStart(2, '0');
        document.getElementById("todayDate").textContent = `오늘: ${tYear}.${tMonth}.${tDate}`;
    }

    // 캘린더 렌더링: 날짜 버튼 생성
    function renderCalendar() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var firstDay = new Date(year, month, 1).getDay();
        var lastDate = new Date(year, month + 1, 0).getDate();
        var calendarBody = document.getElementById("calendarBody");
        calendarBody.innerHTML = "";
        var row = document.createElement("tr");
        var cellCount = 0;

        // 이전 달 빈 셀
        for (var i = 0; i < firstDay; i++) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }

        // 현재 달 날짜 버튼 생성
        for (var d = 1; d <= lastDate; d++) {
            var cell = document.createElement("td");
            var btn = document.createElement("button");
            btn.className = "day-btn";
            btn.textContent = d;
            var fullDate = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            btn.setAttribute("data-date", fullDate);
            // 오늘 날짜 강조
            var today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                btn.classList.add("today");
            }
            btn.addEventListener("click", function() {
                openEventModal(this.getAttribute("data-date"));
            });
            cell.appendChild(btn);
            row.appendChild(cell);
            cellCount++;
            if (cellCount % 7 === 0) {
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }

        // 남은 셀 채우기
        while (cellCount % 7 !== 0) {
            var cell = document.createElement("td");
            row.appendChild(cell);
            cellCount++;
        }
        calendarBody.appendChild(row);
    }

    // 월간 이벤트 목록 갱신 (서버에서 조회하여 events 객체 업데이트 후 화면 갱신)
    function refreshMonthlyEventList() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1;
        // AJAX 요청: /calendar/{role}/events?year=YYYY&month=MM
        fetch(`/calendar/${calendarRole}/events?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                // data는 CalendarEvent 객체 배열입니다.
                // 이벤트를 날짜별로 분류하여 events 전역 객체에 저장
                events = {};  // 초기화
                data.forEach(function(ev) {
                    var key = ev.eventDate;
                    if (!events[key]) {
                        events[key] = [];
                    }
                    events[key].push(ev);
                });
                // 하단 월간 이벤트 목록 갱신
                var listElem = document.getElementById("eventList");
                listElem.innerHTML = "";
                var currentMonthPrefix = `${year}-${String(month).padStart(2,'0')}`;
                for (var dateKey in events) {
                    if (dateKey.startsWith(currentMonthPrefix) && events[dateKey].length > 0) {
                        var li = document.createElement("li");
                        li.textContent = dateKey + ": " + events[dateKey].map(ev => ev.title).join(", ");
                        listElem.appendChild(li);
                    }
                }
            })
            .catch(error => {
                console.error("월간 이벤트 조회 오류:", error);
            });
    }

    // 모달 열기: 해당 날짜의 기존 일정 목록을 로드 및 모달 폼 초기화
    function openEventModal(dateKey) {
        selectedDateKey = dateKey;
        document.getElementById("selectedDateDisplay").textContent = dateKey;

        var existingEventsDiv = document.getElementById("existingEvents");
        if (events[dateKey] && events[dateKey].length > 0) {
            renderExistingEvents(dateKey, events[dateKey]);
        } else {
            existingEventsDiv.innerHTML = "<em style='color:#999;'>일정 없음</em>";
        }

        // 모달 폼 초기화: 이전 수정 정보 삭제
        document.getElementById("eventTitleInput").value = "";
        document.getElementById("eventDescInput").value = "";
        document.getElementById("eventIdInput").value = "";
        document.getElementById("calendarEventModalTitle").textContent = "일정 추가";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // renderExistingEvents: 선택한 날짜의 이벤트 목록을 렌더링 (수정/삭제 버튼 포함)
    function renderExistingEvents(dateKey, eventsForDate) {
        const container = document.getElementById("existingEvents");
        container.innerHTML = "";
        if (eventsForDate && eventsForDate.length > 0) {
            eventsForDate.forEach(event => {
                const eventDiv = document.createElement("div");
                eventDiv.style.display = "flex";
                eventDiv.style.justifyContent = "space-between";
                eventDiv.style.alignItems = "center";
                eventDiv.style.marginBottom = "4px";

                // 이벤트 제목과 설명 표시
                const infoSpan = document.createElement("span");
                infoSpan.textContent = `${event.title} - ${event.description}`;
                eventDiv.appendChild(infoSpan);

                // 버튼 래퍼를 생성하고 flex 설정 (gap을 0으로)
                const btnWrapper = document.createElement("div");
                btnWrapper.style.display = "flex";
                btnWrapper.style.gap = "0px";  // 버튼들 사이 여백 0

                // 수정 버튼 생성 (여기서는 margin을 제거)
                const editBtn = document.createElement("button");
                editBtn.textContent = "수정";
                editBtn.style.marginLeft = "0px";  // margin 제거
                editBtn.addEventListener("click", function() {
                    openEventModalForEdit(dateKey, event);
                });
                btnWrapper.appendChild(editBtn);

                // 삭제 버튼 생성 (여기도 margin 제거)
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "삭제";
                deleteBtn.style.marginLeft = "0px";  // margin 제거
                deleteBtn.addEventListener("click", function() {
                    deleteCalendarEvent(dateKey, event.eventId);
                });
                btnWrapper.appendChild(deleteBtn);

                // 버튼 래퍼를 오른쪽에 붙여넣기
                eventDiv.appendChild(btnWrapper);
                container.appendChild(eventDiv);
            });
        } else {
            container.innerHTML = "<em style='color:#999;'>일정 없음</em>";
        }
    }

    // 수정 모달: 기존 이벤트 데이터를 폼에 로드
    function openEventModalForEdit(dateKey, event) {
        document.getElementById("selectedDateDisplay").textContent = dateKey;
        document.getElementById("eventTitleInput").value = event.title;
        document.getElementById("eventDescInput").value = event.description;
        document.getElementById("eventIdInput").value = event.eventId;
        document.getElementById("calendarEventModalTitle").textContent = "일정 수정";
        document.getElementById("calendarEventModal").style.display = "block";
    }

    // 삭제 처리: 백엔드 삭제 API 호출 후 이벤트 목록 갱신
    function deleteCalendarEvent(dateKey, eventId) {
        if (confirm("해당 일정을 삭제하시겠습니까?")) {
            fetch(`/calendar/delete?eventId=${eventId}`, {
                method: "POST"
            })
                .then(response => response.json())
                .then(function(data) {
                    if (data.success) {
                        alert("일정이 삭제되었습니다.");
                        if (events[dateKey]) {
                            events[dateKey] = events[dateKey].filter(ev => ev.eventId !== eventId);
                            renderExistingEvents(dateKey, events[dateKey]);
                        }
                        refreshMonthlyEventList();
                    } else {
                        alert("삭제 실패: " + data.message);
                    }
                })
                .catch(function(error) {
                    console.error("삭제 요청 오류:", error);
                    alert("삭제 처리 중 오류가 발생하였습니다.");
                });
        }
    }

    // 모달 폼 제출: 신규 생성 또는 수정 작업 처리
    document.getElementById("calendarEventForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var dateStr = document.getElementById("selectedDateDisplay").textContent;
        var title = document.getElementById("eventTitleInput").value.trim();
        var desc = document.getElementById("eventDescInput").value.trim();
        var eventId = document.getElementById("eventIdInput").value.trim(); // 수정 시 값 존재

        if (!title) {
            alert("제목을 입력하세요.");
            return;
        }

        var url = `/calendar/${calendarRole}/save?eventDate=${encodeURIComponent(dateStr)}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(desc)}`;
        if (eventId) {
            url += `&eventId=${encodeURIComponent(eventId)}`;
        }

        fetch(url, { method: "POST" })
            .then(response => response.json())
            .then(function(data) {
                alert(data.message);
                document.getElementById("calendarEventModal").style.display = "none";
                // 새로 저장된 이벤트를 갱신하기 위해 리프레시
                refreshMonthlyEventList();
                renderCalendar();
            })
            .catch(function(error) {
                console.error("저장 오류:", error);
                alert("일정 저장 중 오류 발생");
            });
    });

    // 이전/다음 달 버튼 처리
    document.getElementById("prevMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });
    document.getElementById("nextMonthBtn").addEventListener("click", function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarBanner();
        renderCalendar();
        refreshMonthlyEventList();
    });

    // 초기 실행
    updateCalendarBanner();
    renderCalendar();
    refreshMonthlyEventList();

    document.getElementById("closeCalendarEventModal").onclick = function() {
        document.getElementById("calendarEventModal").style.display = "none";
    };

    document.getElementById("calendarEventModal").addEventListener("click", function(event) {
        if (event.target === this) {
            this.style.display = "none";
        }
    });


</script>
<script>
    // 호출 버튼 클릭 이벤트 (대기 리스트 내에서 위임 방식)
    document.getElementById("doctorPatientList").addEventListener("click", function(e) {
        // "호출" 버튼 클릭 시 (아직 호출되지 않은 경우)
        if (e.target && e.target.classList.contains("call-btn")) {
            const patientId = e.target.getAttribute("data-id");
            if (!patientId) return;
            console.log("의사 페이지: 호출 버튼 클릭, patientId:", patientId);
            // 호출 이벤트를 nurse 페이지로 전달 (예: localStorage에 이벤트 등록)
            localStorage.setItem("callPatient", JSON.stringify({ patientId: patientId }));
        }
        // "진료중" 버튼 클릭 시
        else if (e.target && e.target.classList.contains("in-consultation-btn")) {
            const patientId = e.target.getAttribute("data-id");
            if (!patientId) return;
            if (!confirm("진료 완료 처리 하시겠습니까?")) return;

            fetch('/patient/call/complete', {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "patientId=" + encodeURIComponent(patientId)
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    return fetch('/medicalvisit/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ patientId: patientId })
                    });
                })
                .then(res2 => res2.json())
                .then(json2 => {
                    if (json2.success) {
                        console.log('MedicalVisit 최신 레코드 삭제 완료');
                    } else {
                        console.warn('MedicalVisit 삭제 실패:', json2.message);
                    }
                })
                .then(() => {
                    refreshDoctorWaitingList();
                })
                .catch(error => {
                    console.error("진료 완료 처리 실패:", error);
                    alert("진료 완료 처리에 실패하였습니다.");
                });
        }
    });

    function refreshStats() {
        fetch('/patient/stats')
            .then(response => {
                if (!response.ok) throw new Error("네트워크 응답 오류");
                return response.json();
            })
            .then(data => {
                document.getElementById('waitingCount').innerText = data.waitingCount + "명";
                document.getElementById('collectionCount').innerText = data.collectionCount + "명";
            })
            .catch(error => {
                console.error("Stats refresh error:", error);
            });
    }

    // 페이지 로드 시 및 5초 간격으로 업데이트
    refreshStats();
    setInterval(refreshStats, 5000);

    function refreshDoctorWaitingList() {
        fetch('/patient/doctor/waiting')
            .then(response => {
                if(!response.ok) {
                    throw new Error("네트워크 응답 오류");
                }
                return response.text();
            })
            .then(html => {
                document.getElementById("doctorPatientList").innerHTML = html;
            })
            .catch(error => console.error("의사 대기 리스트 로드 오류:", error));
    }
    refreshDoctorWaitingList();
    setInterval(refreshDoctorWaitingList, 5000);
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 올바른 컨테이너 ID인 "doctorPatientList"에 이벤트 위임
        document.getElementById("doctorPatientList").addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("call-btn")) {
                const patientId = e.target.getAttribute("data-id");
                if (!patientId) return;
                // 호출 이벤트를 localStorage에 등록 (다른 탭에서 storage 이벤트 발생)
                localStorage.setItem("callPatient", JSON.stringify({ patientId: patientId }));
                // 호출 후 버튼을 비활성화하거나 UI 업데이트 추가 가능
            }
        });
    });
</script>
<script>
    // 페이지 로드 시, 진단 리스트에 최초 행 추가
    document.addEventListener("DOMContentLoaded", function() {
        // 만약 진단 테이블의 tbody 내에 행이 없으면 새 행 추가
        if (!document.querySelector("#diagnosisTable tbody tr")) {
            addDiagnosisRow();
        }
    });
    // 진단 행을 추가하는 함수
    function addDiagnosisRow() {
        const tbody = document.querySelector("#diagnosisTable tbody");
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
          <td><input type="text" class="diag-code" placeholder="" /></td>
          <td><input type="text" class="diag-name" placeholder="진단 명 입력" /></td>
          <td><input type="text" class="diag-dept" value="이비인후과" readonly /></td>
          <td><button type="button" class="deleteDiagnosisRowBtn">X</button></td>
      `;
        tbody.appendChild(newRow);
        // 삭제 버튼 클릭 시 해당 행 삭제 이벤트 추가
        const deleteBtn = newRow.querySelector(".deleteDiagnosisRowBtn");
        deleteBtn.addEventListener("click", function() {
            newRow.parentNode.removeChild(newRow);
        });
        // 진단 명 입력란에 키다운 이벤트 추가하여 탭(Tab) 또는 엔터(Enter) 시 새 행 추가
        const diagNameInput = newRow.querySelector(".diag-name");
        diagNameInput.addEventListener("keydown", function(e) {
            if (e.key === "Tab" || e.key === "Enter") {
                e.preventDefault(); // 기본 탭 이동 또는 폼 제출 방지
                addDiagnosisRow();  // 새 행 추가
                // 새로 추가된 행의 진단 코드 입력란으로 포커스 이동
                const rows = document.querySelectorAll("#diagnosisTable tbody tr");
                if (rows.length > 0) {
                    rows[rows.length - 1].querySelector(".diag-code").focus();
                }
            }
        });
        const newDiagInput = newRow.querySelector(".diag-name");
        setupDiagnosisAutocomplete(newDiagInput);
    }
    // "진단 행 추가" 버튼 이벤트 리스너 설정
    document.addEventListener("DOMContentLoaded", function() {
        const addDiagnosisRowBtn = document.getElementById("addDiagnosisRowBtn");
        addDiagnosisRowBtn.addEventListener("click", addDiagnosisRow);

        function addDiagnosisRow() {
            const tbody = document.querySelector("#diagnosisTable tbody");
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
            <td><input type="text" class="diag-code" placeholder="예: J18" /></td>
            <td><input type="text" class="diag-name" placeholder="진단 명 입력" /></td>
            <td><input type="text" class="diag-dept" value="이비인후과" readonly /></td>
            <td><button type="button" class="deleteDiagnosisRowBtn">X</button></td>
        `;
            tbody.appendChild(newRow);

            // 삭제 버튼 이벤트
            const deleteBtn = newRow.querySelector(".deleteDiagnosisRowBtn");
            deleteBtn.addEventListener("click", function() {
                newRow.parentNode.removeChild(newRow);
            });
            const newDiagInput = newRow.querySelector(".diag-name");
            setupDiagnosisAutocomplete(newDiagInput);
        }
    });

    // DOMContentLoaded 시 시작 일자 자동설정
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("startDate").value = new Date().toISOString().split("T")[0];
    });

    document.addEventListener("DOMContentLoaded", function() {
        const diagNameInputs = document.querySelectorAll(".diag-name");
        diagNameInputs.forEach(input => {
            setupDiagnosisAutocomplete(input);
        });
    });
</script>
<script>

    // 기본 텍스트 포맷팅 함수 (execCommand 사용)
    function formatText(command) {
        document.execCommand(command, false, null);
    }
    // 폰트 크기 변경 함수
    function changeFontSize(size) {
        // 우선 선택된 텍스트에 대해 fontSize를 최대값인 "7"로 적용
        document.execCommand("fontSize", false, "7");
        // 그 후, recordEditor 내부의 <font size="7"> 태그들을 찾아 원하는 픽셀값으로 변경
        var editor = document.getElementById("recordEditor");
        var fontElements = editor.getElementsByTagName("font");
        for (var i = 0; i < fontElements.length; i++) {
            if (fontElements[i].getAttribute("size") === "7") {
                fontElements[i].removeAttribute("size");
                fontElements[i].style.fontSize = size + "px";
            }
        }
    }
</script>

<script>
    var currentPatientId = null;

    function loadReceptionMemo(patientId) {
        fetch('/patient/receptionMemo?patientId=' + encodeURIComponent(patientId))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("receptionMemo").textContent = data.memo;
                } else {
                    document.getElementById("receptionMemo").textContent = "없음";
                }
            })
            .catch(error => {
                console.error("접수 메모 불러오기 오류:", error);
            });
    }

    // 현재 진료중인 환자 정보를 서버에서 가져와 UI에 뿌림
    async function loadCurrentConsultationPatient() {
        const res = await fetch('/medicalvisit/currentPatient');
        const data = await res.json();
        if (!data.success || !data.visitId) {
            document.querySelector('.main-content').innerHTML =
                '<p style="text-align:center;color:#999;">환자를 호출하고 접수 기록을 완료해주세요.</p>';
            return;
        }

        // 존재하는 visitId가 있을 때만 UI 업데이트 & 과거 이력 로딩
        currentVisitId  = data.visitId;
        currentPatientId = data.patientId;
        document.getElementById("patientName").textContent   = data.patientName;
        document.getElementById("patientAge").textContent    = data.patientAge;
        document.getElementById("patientGender").textContent = data.patientGender;
        document.getElementById("patientPhone").textContent  = data.patientPhone;

        document.getElementById("clinicalMemo").value = data.clinicalMemo || "";
        // (원래) 접수 메모를 별도로 Patient 엔드포인트에서 가져오는 로직도 분리하세요
        loadReceptionMemo(currentPatientId);

        // 과거 진료 기록은 visitId가 있을 때만
        loadVisitHistory(currentPatientId);
    }

    document.addEventListener("DOMContentLoaded", function() {
        loadCurrentConsultationPatient();
    });

    // 기본 텍스트 포맷팅 함수
    function formatText(command) {
        document.execCommand(command, false, null);
    }

    // 폰트 크기 변경 함수
    function changeFontSize(size) {
        document.execCommand("fontSize", false, "7");
        var editor = document.getElementById("recordEditor");
        var fontElements = editor.getElementsByTagName("font");
        for (var i = 0; i < fontElements.length; i++) {
            if (fontElements[i].getAttribute("size") === "7") {
                fontElements[i].removeAttribute("size");
                fontElements[i].style.fontSize = size + "px";
            }
        }
    }
</script>
<script>
    // 전역 변수: 현재 진료 기록의 visitId와 환자의 patientId
    var currentVisitId = null;
    var currentPatientId = null;

    // 페이지 로드시 현재 진료중인 환자의 정보와 최신 진료 기록 visitId, patientId 가져오기
    fetch('/medicalvisit/currentPatient')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentVisitId = data.visitId;
                currentPatientId = data.patientId; // 엔드포인트에서 patientId도 함께 반환해야 함
                // 환자 정보 UI 업데이트
                document.getElementById("patientName").textContent = data.patientName;
                document.getElementById("patientAge").textContent = data.patientAge;
                document.getElementById("patientGender").textContent = data.patientGender;
                document.getElementById("patientPhone").textContent = data.patientPhone;
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error("현재 진료중인 환자 정보 조회 오류:", error));



    let prescriptionRowIndex = 0;
    function addPrescriptionRow() {
        const idx = prescriptionRowIndex++;
        const tbody = document.getElementById("prescriptionTable").querySelector("tbody");
        const newRow = document.createElement("tr");
        newRow.setAttribute("data-row-index", idx);
        newRow.innerHTML = `
        <td><input type="text" class="prescription-code" style="width:95%;"/></td>
        <td>
            <input type="text" class="prescription-name" style="width:95%;" placeholder="약물 명칭">
            <div class="autocomplete-suggestions" style="display:none; border:1px solid #ccc; max-height:150px; overflow-y:auto; background:#fff;"></div>
        </td>
        <td>
            <input type="number" class="prescription-dosage-value" style="width:50px;" placeholder="용량">
            <select class="prescription-dosage-unit" style="width:40px;">
                <option value="ml">ml</option>
                <option value="mg">mg</option>
                <option value="개">개</option>
            </select>
        </td>
        <td><input type="number" class="prescription-duration" style="width:95%;" placeholder="일수"/></td>
        <td><input type="number" class="prescription-frequency" style="width:90%;"placeholder="횟수" min="1" value="1" /></td>
        <td>
        <div class="insurance-radio-group">
            <label>
                <input type="radio" name="prescription-insurance-${idx}" value="true" checked />
                급여
            </label>
            <label>
                <input type="radio" name="prescription-insurance-${idx}" value="false" />
                비급여
            </label>
        </div>
        </td>
        <td>
        <div class="timing-radio-group">
            <label>
                <input type="radio" name="prescription-timing-${idx}" value="식전 30분" checked />
                식전
            </label>
            <label>
                <input type="radio" name="prescription-timing-${idx}" value="식후 30분" />
                식후
            </label>
        </div>
        </td>
        <td><button type="button" class="deletePrescriptionRowBtn" style="width:100%;">X</button></td>
    `;
        tbody.appendChild(newRow);

        const newInput = newRow.querySelector(".prescription-name");
        if (newInput) {
            setupAutocomplete(newInput);
        }

        // 삭제 버튼 이벤트 설정
        newRow.querySelector(".deletePrescriptionRowBtn").addEventListener("click", function() {
            newRow.parentNode.removeChild(newRow);
        });

        prescriptionRowIndex++;
    }
    document.getElementById("addPrescriptionRowBtn").addEventListener("click", addPrescriptionRow);
    if (!document.querySelector("#prescriptionTable tbody tr")) {
        addPrescriptionRow();
    }

    // 처방 행 삭제
    document.getElementById("prescriptionTable").addEventListener("click", function(e) {
        if (e.target && e.target.classList.contains("deletePrescriptionRowBtn")) {
            const row = e.target.closest("tr");
            row.parentNode.removeChild(row);
        }
    });

    // 역대 진료 기록 로딩: 현재 환자의 patientId로 호출
    function loadVisitHistory(patientId) {
        fetch('/medicalvisit/history?patientId=' + encodeURIComponent(patientId))
            .then(res => res.json())
            .then(data => {
                const allVisits = Array.isArray(data) ? data : data.visits || [];
                const historyVisits = allVisits.filter(v => v.visitId !== currentVisitId);
                renderVisitHistoryList(historyVisits);
            })
            .catch(console.error);
    }

    function formatTime(timeStr) {
        if (!timeStr) return "";
        // 예시: "13:05:00" -> "오후 1시 05분"
        const parts = timeStr.split(":");
        let hour = parseInt(parts[0], 10);
        const minute = parts[1]; // 초는 무시
        const period = hour < 12 ? "오전" : "오후";
        hour = hour % 12;
        if (hour === 0) hour = 12;
        return `${period} ${hour}:${minute}`;
    }

    function renderVisitHistoryList(visits) {
        const listElem = document.getElementById("visitHistoryList");
        listElem.innerHTML = "";
        visits.forEach(visit => {
            const li = document.createElement("li");
            li.textContent = visit.visitDate + "\n" + formatTime(visit.visitTime);
            li.style.whiteSpace = "pre-line";
            li.style.cursor = "pointer";
            li.addEventListener("click", () => {
                showVisitDetail(visit);
                listElem.querySelectorAll("li").forEach(el => el.classList.remove("selected"));
                li.classList.add("selected");
            });
            listElem.appendChild(li);
        });
        const first = listElem.querySelector("li");
        if (first) {
            first.classList.add("selected");
            visits[0] && showVisitDetail(visits[0]);
        } else {
            // 날짜/시간/메모/기록 초기화
            document.getElementById("historyVisitDate").textContent = "-";
            document.getElementById("historyVisitTime").textContent = "";
            document.getElementById("historyMemoSection").textContent = "";
            document.getElementById("historyNotesSection").innerHTML = "";

            // 검사 결과 요약 초기화
            document.getElementById("historyExamSummary").innerHTML =
                "<p style='color:#999;'>검사 결과가 없습니다.</p>";
            // 이미지 캐러셀 초기화 및 버튼 비활성화
            document.getElementById("examImagesContainer").innerHTML = "";
            document.getElementById("examPrevBtn").disabled = true;
            document.getElementById("examNextBtn").disabled = true;

            // 진단 리스트 초기화
            document.getElementById("historyDiagnosisList").innerHTML =
                "<li style='color:#999;'>진단 기록이 없습니다.</li>";

            // 처방 테이블 초기화 (colspan=6)
            document.getElementById("historyPrescriptionTbody").innerHTML =
                "<tr><td colspan='6' style='text-align:center; color:#999;'>처방 내역이 없습니다.</td></tr>";
        }
    }

    function showVisitDetail(visit) {
        // 1) 날짜/시간/메모/기록
        document.getElementById("historyVisitDate").textContent = visit.visitDate || "-";
        document.getElementById("historyVisitTime").textContent = visit.visitTime ? formatTime(visit.visitTime) : "";
        document.getElementById("historyReasonSection").textContent  = visit.visitReason  || "";
        document.getElementById("historyMemoSection").textContent = visit.clinicalMemo || "";
        document.getElementById("historyNotesSection").innerHTML = visit.clinicalNotes || "";

        // 2) 검사 결과
        const summaryBox      = document.getElementById("historyExamSummary");
        const imagesContainer = document.getElementById("examImagesContainer");
        const prevBtn         = document.getElementById("examPrevBtn");
        const nextBtn         = document.getElementById("examNextBtn");

        // 초기화
        summaryBox.innerHTML      = "";
        imagesContainer.innerHTML = "";
        prevBtn.disabled = nextBtn.disabled = true;

        // visitId에 해당하는 'examDate, examType, examSummary, mediaList' 받아오기
        fetch(`/examination/history?visitId=${visit.visitId}`)
            .then(res => res.json())
            .then(exams => {
                if (!exams.length) {
                    summaryBox.innerHTML = "<p style='color:#999;'>검사 기록이 없습니다.</p>";
                    return;
                }

                // ——— 2-1) examType + examSummary 렌더 ———
                exams.forEach(exam => {
                    const div = document.createElement("div");
                    div.style.marginBottom = "6px";
                    div.innerHTML = `
            <strong>${exam.examDate} / ${exam.examType}</strong><br>
            <span>${exam.examSummary || ""}</span>
          `;
                    summaryBox.appendChild(div);
                });

                // ——— 2-2) mediaList 평탄화 → 기존 이미지 페이징 로직 호출 ———
                const imgs    = exams.flatMap(e => e.mediaList || []);
                let   page    = 0;
                const perPage = 4;

                function renderPage() {
                    imagesContainer.innerHTML = "";
                    imgs
                        .slice(page * perPage, page * perPage + perPage)
                        .forEach(src => {
                            const img = document.createElement("img");
                            img.src             = src;
                            img.style.maxWidth  = "120px";
                            img.style.margin    = "0 4px";
                            img.style.objectFit = "cover";
                            imagesContainer.appendChild(img);
                        });
                    prevBtn.disabled = (page === 0);
                    nextBtn.disabled = ((page + 1) * perPage >= imgs.length);
                }

                prevBtn.onclick = () => {
                    if (page > 0) {
                        page--;
                        renderPage();
                    }
                };
                nextBtn.onclick = () => {
                    if ((page + 1) * perPage < imgs.length) {
                        page++;
                        renderPage();
                    }
                };

                renderPage();
            })
            .catch(err => {
                console.error("검사 결과 로드 실패", err);
                summaryBox.innerHTML      = "<p style='color:#c00;'>검사 결과 로드 중 오류</p>";
                imagesContainer.innerHTML = "";
            });

        // 3) 과거 진단
        const diagList = document.getElementById("historyDiagnosisList");
        diagList.innerHTML = "";
        if (visit.diagnoses && visit.diagnoses.length) {
            visit.diagnoses.forEach(d => {
                const li = document.createElement("li");
                li.textContent = `${d.diagnosisCode} – ${d.diagnosisName}`;
                diagList.appendChild(li);
            });
        } else {
            diagList.innerHTML = "<li style='color:#999;'>진단 기록이 없습니다.</li>";
        }

        // 4) 처방 내역
        const tbody = document.getElementById("historyPrescriptionTbody");
        tbody.innerHTML = "";
        if (visit.prescriptions && visit.prescriptions.length) {
            visit.prescriptions.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${p.drugCode   || ""}</td>
        <td>${p.drugName   || ""}</td>
        <td>${p.dosage     || ""}</td>
        <td>${p.days != null ? p.days : ""}</td>
        <td>${p.frequency  || ""}</td>
        <td>${p.insuranceYn ? "급여" : "비급여"}</td>
      `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999;'>처방 내역 없음</td></tr>";
        }
    }

    // 보조 함수: "HH:mm:ss" → "오전/오후 H:mm"
    function formatTime(timeStr) {
        if (!timeStr) return "";
        const [hh, mm] = timeStr.split(":");
        let hour = parseInt(hh, 10), period = "오전";
        if (hour >= 12) { period = "오후"; hour -= 12; }
        if (hour === 0) hour = 12;
        return `${period} ${hour}:${mm}`;
    }



    if (currentPatientId) {
        loadVisitHistory(currentPatientId);
    }

</script>
<script>
    let drugData = [];

    function loadDrugData() {
        Papa.parse("/valid_ENT_codes.csv", {
            download: true,
            header: true,
            complete: function(results) {
                drugData = results.data; // CSV의 각 행은 객체로 저장됩니다.
                console.log("Drug Data loaded:", drugData);
            },
            error: function(err) {
                console.error("CSV 파싱 오류:", err);
            }
        });
    }

    window.addEventListener("DOMContentLoaded", loadDrugData);
    document.addEventListener("DOMContentLoaded", function() {
        const inputs = document.querySelectorAll(".prescription-name");
        inputs.forEach(input => {
            setupAutocomplete(input);
        });
    });

    function setupAutocomplete(inputElement) {
        const suggestionBox = document.createElement('div');
        suggestionBox.classList.add('autocomplete-suggestions');
        suggestionBox.style.cssText = "position:absolute; border:1px solid #ccc; background:#fff; max-height:150px; overflow-y:auto; z-index: 1000; display:none;";
        // 입력란 바로 아래에 컨테이너 추가 (부모 요소에 position: relative; 가 있어야 올바르게 위치합니다.)
        inputElement.parentNode.style.position = "relative";
        inputElement.parentNode.insertBefore(suggestionBox, inputElement.nextSibling);

        // 입력창 이벤트 처리
        inputElement.addEventListener("keyup", function() {
            const query = inputElement.value.trim();
            // 최소 2글자 이상 입력
            if (query.length < 2) {
                suggestionBox.style.display = "none";
                return;
            }
            // drugData 배열이 로드되어 있지 않다면 리턴
            if (!drugData || !drugData.length) return;

            // CSV의 'kor' 필드를 기준으로 검색 (대소문자 구분 없이)
            const matches = drugData.filter(item => {
                return item.kor && item.kor.toLowerCase().includes(query.toLowerCase());
            });

            // 추천 목록 생성
            suggestionBox.innerHTML = "";
            if (matches.length === 0) {
                suggestionBox.style.display = "none";
                return;
            }
            matches.forEach(match => {
                const div = document.createElement("div");
                div.textContent = match.kor; // 표시할 텍스트는 한글 명칭
                div.style.padding = "5px";
                div.style.cursor = "pointer";
                // 마우스 오버 시 배경색 변경
                div.addEventListener("mouseover", () => {
                    div.style.backgroundColor = "#f0f0f0";
                });
                div.addEventListener("mouseout", () => {
                    div.style.backgroundColor = "#fff";
                });
                // 클릭 시, 입력란과 관련 코드 필드 자동 채우기
                div.addEventListener("click", () => {
                    inputElement.value = match.kor;
                    // 해당 입력란의 컨테이너에서 코드 입력란 찾기 (클래스는 .prescription-code 사용)
                    const containerRow = inputElement.closest("tr");
                    if (containerRow) {
                        const codeInput = containerRow.querySelector(".prescription-code");
                        if (codeInput) {
                            codeInput.value = match.code;
                        }
                    }
                    suggestionBox.style.display = "none";
                });
                suggestionBox.appendChild(div);
            });
            suggestionBox.style.display = "block";
        });

        // 입력란 포커스 아웃 시 추천 목록 숨기기
        inputElement.addEventListener("blur", function() {
            // 약간의 딜레이 후에 숨기기: 클릭 이벤트가 먼저 처리되도록
            setTimeout(() => {
                suggestionBox.style.display = "none";
            }, 150);
        });
    }

    let diagnosisData = [];

    function loadDiagnosisData() {
        Papa.parse("/valid_KCD_codes.csv", {
            download: true,
            header: true,
            complete: function(results) {
                diagnosisData = results.data;
                console.log("Diagnosis Data loaded:", diagnosisData);
            },
            error: function(err) {
                console.error("진단 CSV 파싱 오류:", err);
            }
        });
    }

    window.addEventListener("DOMContentLoaded", loadDiagnosisData);

    function setupDiagnosisAutocomplete(inputElement) {
        const suggestionBox = document.createElement('div');
        suggestionBox.classList.add('diagnosis-autocomplete-suggestions');
        // 스타일은 필요에 따라 CSS로 분리 가능 (여기서는 인라인 스타일로 예시)
        suggestionBox.style.cssText = "position:absolute; border:1px solid #ccc; background:#fff; max-height:150px; overflow-y:auto; z-index:1000; display:none;";

        // 입력란의 부모 요소에 position: relative; 설정 (이미 설정되어 있지 않다면)
        inputElement.parentNode.style.position = "relative";
        inputElement.parentNode.insertBefore(suggestionBox, inputElement.nextSibling);

        inputElement.addEventListener("keyup", function() {
            const query = inputElement.value.trim();
            // 2글자 이상 입력되었을 때 추천 목록 표시
            if (query.length < 2) {
                suggestionBox.style.display = "none";
                return;
            }
            // CSV 데이터가 로드되지 않았다면 return
            if (!diagnosisData || !diagnosisData.length) return;

            const matches = diagnosisData.filter(item => {
                // item['병명'] 필드에 query가 포함되어 있는지 확인 (대소문자 구분 없이)
                return item['name'] && item['name'].toLowerCase().includes(query.toLowerCase());
            });

            // 추천 목록 생성
            suggestionBox.innerHTML = "";
            if (matches.length === 0) {
                suggestionBox.style.display = "none";
                return;
            }
            matches.forEach(match => {
                const div = document.createElement("div");
                // 표시할 텍스트: 예) "J18 - 중이염"
                div.textContent = `${match['code']} - ${match['name']}`;
                div.style.padding = "5px";
                div.style.cursor = "pointer";

                // 마우스오버 시 배경 색상 변경
                div.addEventListener("mouseover", () => {
                    div.style.backgroundColor = "#f0f0f0";
                });
                div.addEventListener("mouseout", () => {
                    div.style.backgroundColor = "#fff";
                });
                // 클릭하면 입력란과 연관된 진단 코드 입력란에 값을 채워줌
                div.addEventListener("click", () => {
                    inputElement.value = match['name'];
                    // 동일한 행에 있는 진단 코드 입력란(.diag-code)을 찾습니다.
                    const containerRow = inputElement.closest("tr");
                    if (containerRow) {
                        const codeInput = containerRow.querySelector(".diag-code");
                        if (codeInput) {
                            codeInput.value = match['code'];
                        }
                    }
                    suggestionBox.style.display = "none";
                });
                suggestionBox.appendChild(div);
            });
            suggestionBox.style.display = "block";
        });

        // 입력란 포커스 아웃 시 추천 목록을 숨김 (딜레이 적용)
        inputElement.addEventListener("blur", function() {
            setTimeout(() => {
                suggestionBox.style.display = "none";
            }, 150);
        });
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const completeBtn = document.getElementById("completeVisitBtn");
        if (!completeBtn) {
            console.warn("completeVisitBtn 버튼이 존재하지 않습니다.");
            return;
        }

        completeBtn.addEventListener("click", async function () {
            console.log("진료 완료 버튼 클릭됨");
            alert("진료 완료 버튼이 클릭되었습니다."); // 클릭 확인용

            // 진료 메모와 기록 값 가져오기
            const memo = document.getElementById("clinicalMemo").value;
            const record = document.getElementById("recordEditor").innerHTML;
            console.log("Memo:", memo);
            console.log("Record:", record);

            // currentVisitId와 currentPatientId는 다른 부분(예를 들어, 페이지 로드 시 /medicalvisit/currentPatient를 통해 설정됨)
            if (!currentVisitId || !currentPatientId) {
                alert("진료 기록 업데이트할 대상(환자 정보 또는 진료 기록)이 없습니다.");
                return;
            }
            console.log("currentVisitId:", currentVisitId, "currentPatientId:", currentPatientId);

            try {
                // 1) 진료 메모(clinicalMemo) 업데이트
                let memoRes = await fetch('/medicalvisit/updateClinicalMemo', {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        visitId: currentVisitId,
                        clinicalMemo: memo
                    })
                });
                let memoJson = await memoRes.json();
                if (!memoJson.success) throw new Error(memoJson.message || "진료 메모 저장 실패");

                // 2) 진료 기록(clinicalNotes) 업데이트
                let noteRes = await fetch('/medicalvisit/updateClinicalNotes', {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        visitId: currentVisitId,
                        record: record
                    })
                });
                let noteJson = await noteRes.json();
                if (!noteJson.success) throw new Error(noteJson.message || "진료 기록 저장 실패");

                // 2. 처방 정보 수집 및 저장 (/prescription/save)
                const prescriptionRows = document.querySelectorAll("#prescriptionTable tbody tr");
                let prescriptions = [];
                prescriptionRows.forEach(function (row) {
                    const rowIndex = row.getAttribute("data-row-index");
                    const code = row.querySelector(".prescription-code").value.trim();
                    const name = row.querySelector(".prescription-name").value.trim();
                    const dosageValue = row.querySelector(".prescription-dosage-value").value.trim();
                    const unit = row.querySelector(".prescription-dosage-unit").value;
                    const dosage = dosageValue ? dosageValue + unit : "";
                    const duration = row.querySelector(".prescription-duration").value.trim();
                    const freq = row.querySelector(".prescription-frequency").value.trim();
                    const insuranceElem = row.querySelector(`input[name="prescription-insurance-${rowIndex}"]:checked`);
                    const timingElem = row.querySelector(`input[name="prescription-timing-${rowIndex}"]:checked`);
                    const insuranceYn = insuranceElem ? (insuranceElem.value === "true") : false;
                    const timing = timingElem ? timingElem.value : "";
                    if (code || name || dosage || duration || timing) {
                        prescriptions.push({
                            visitId: currentVisitId,
                            drugCode: code,
                            drugName: name,
                            dosage: dosage,
                            days: duration ? parseInt(duration) : null,
                            frequency: freq ? parseInt(freq, 10) : 1,
                            insuranceYn: insuranceYn,
                            timing: timing
                        });
                    }
                });
                if (prescriptions.length > 0) {
                    let prescriptionResponse = await fetch('/prescription/save', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(prescriptions)
                    });
                    let prescriptionResult = await prescriptionResponse.json();
                    if (!prescriptionResult.success) {
                        alert("처방 저장 실패: " + prescriptionResult.message);
                    }
                    console.log("처방 저장 완료");
                } else {
                    console.log("저장할 처방 데이터 없음");
                }

                // 3. 진단 데이터 수집 및 저장 (/diagnosis/saveAll)
                const diagnosisRows = document.querySelectorAll("#diagnosisTable tbody tr");
                let diagnoses = [];
                diagnosisRows.forEach(function (row) {
                    const diagCode = row.querySelector(".diag-code").value.trim();
                    const diagName = row.querySelector(".diag-name").value.trim();
                    const dept = row.querySelector(".diag-dept").value.trim();
                    if (diagCode || diagName) {
                        diagnoses.push({
                            visitId: currentVisitId,
                            patientId: currentPatientId,
                            diagnosisCode: diagCode,
                            diagnosisName: diagName,
                            department: dept
                        });
                    }
                });
                let diagId;
                if (diagnoses.length > 0) {
                    let diagnosisResponse = await fetch('/diagnosis/saveAll', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(diagnoses)
                    });
                    let diagnosisResult = await diagnosisResponse.json();
                    if (!diagnosisResult.success) {
                        throw new Error("진단 기록 저장 실패: " + diagnosisResult.message);
                    }
                    // 저장된 진단 기록이 여러 건일 경우 첫 번째 진단 ID 사용
                    if (diagnosisResult.diagnoses && diagnosisResult.diagnoses.length > 0) {
                        diagId = diagnosisResult.diagnoses[0].diagnosisId;
                    } else {
                        diagId = diagnosisResult.diagnosisId;
                    }
                    if (!diagId) {
                        throw new Error("진단 ID가 반환되지 않았습니다.");
                    }
                    console.log("진단 저장 완료, 선택된 진단 ID:", diagId);
                } else {
                    throw new Error("저장할 진단 데이터가 없습니다.");
                }

                // 4. 치료 계획 데이터 수집 및 저장 (/treatmentplan/save)
                // radio 버튼에서 치료 상태를 선택할 때는 아래와 같이 querySelector 사용
                let treatmentStatus = document.querySelector('input[name="treatmentStatus"]:checked').value;
                let treatmentDescription = document.getElementById("treatmentDescription").value.trim();
                let startDate = document.getElementById("startDate").value.trim();
                let endDate = document.getElementById("endDate").value.trim();
                let treatmentParams = new URLSearchParams({
                    diagnosisId: diagId,
                    treatmentDescription: treatmentDescription,
                    startDate: startDate,
                    endDate: endDate,
                    status: treatmentStatus
                });
                let treatmentResponse = await fetch('/treatmentplan/save', {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: treatmentParams
                });
                let treatmentResult = await treatmentResponse.json();
                if (!treatmentResult.success) {
                    throw new Error("치료 계획 저장 실패: " + treatmentResult.message);
                }
                console.log("치료 계획 저장 완료");

                // 5. 검사 결과 저장
                const examRows = document.querySelectorAll("#examinationTbody tr");
                if (examRows.length > 0) {
                    const examForm = new FormData();
                    examForm.append("visitId", currentVisitId);
                    examRows.forEach((row, idx) => {
                        // 날짜, 종류, 요약
                        examForm.append(`exams[${idx}].examDate`, row.querySelector(".exam-date").value);
                        examForm.append(`exams[${idx}].examType`, row.querySelector(".exam-type").value);
                        examForm.append(`exams[${idx}].examSummary`, row.querySelector(".exam-summary").value);
                        // 다중 이미지
                        const files = row.querySelector(".exam-media").files;
                        for (let i = 0; i < files.length; i++) {
                            examForm.append(`exams[${idx}].mediaFiles`, files[i]);
                        }
                    });
                    const examRes = await fetch("/examination/saveAll", {
                        method: "POST",
                        body: examForm
                    });
                    const examJson = await examRes.json();
                    if (!examJson.success) {
                        throw new Error("검사 결과 저장 실패: " + examJson.message);
                    }
                    console.log("검사 결과 저장 완료");
                }

                // 6. 최종적으로 환자 상태 업데이트 (/patient/call/complete)
                let completeResponse = await fetch('/patient/call/complete', {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ patientId: currentPatientId })
                });
                let completeResult = await completeResponse.json();
                if (!completeResult.success) {
                    throw new Error("진료 완료 처리 실패: " + completeResult.message);
                }
                console.log("환자 진료 완료 처리 완료");

                alert("진료 기록, 처방, 진단 기록, 치료 계획 및 환자 완료 처리가 성공적으로 완료되었습니다.");
                location.reload();

            } catch (error) {
                console.error("진료 완료 처리 중 오류:", error);
                alert("진료 완료 처리 중 오류가 발생하였습니다: " + error.message);
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('examinationTbody');

        // 1) 파일 입력 change 이벤트 위임
        tbody.addEventListener('change', e => {
            if (!e.target.matches('.exam-media')) return;
            const fileInput = e.target;
            const row = fileInput.closest('tr');
            const previewDiv = row.querySelector('.image-preview');
            previewDiv.innerHTML = '';

            Array.from(fileInput.files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('이미지 파일만 업로드 가능합니다.');
                    fileInput.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = ev => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.maxWidth = '80px';
                    img.style.maxHeight = '80px';
                    img.style.objectFit = 'cover';
                    previewDiv.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // 2) 검사 행 추가 함수
        function addExaminationRow() {
            const row = document.createElement('tr');
            row.innerHTML = `
      <td><input type="date" class="exam-date" readonly /></td>
      <td><input type="text" class="exam-type" placeholder="예: 혈액검사" /></td>
      <td><input type="text" class="exam-summary" placeholder="간단히 요약" /></td>
      <td>
        <input type="file" class="exam-media" accept="image/*" multiple />
        <div class="image-preview" style="display:flex; gap:8px; margin-top:4px;"></div>
      </td>
      <td><button type="button" class="deleteExamRowBtn">X</button></td>
    `;
            // 오늘 날짜 세팅
            row.querySelector('.exam-date').value = new Date().toISOString().slice(0,10);
            // 삭제 버튼
            row.querySelector('.deleteExamRowBtn').addEventListener('click', () => row.remove());
            tbody.appendChild(row);
        }

        // + 버튼 바인딩
        document.getElementById('addExaminationRowBtn')
            .addEventListener('click', addExaminationRow);

        // 로드 시 첫 행 추가 (선택)
        if (!tbody.querySelector('tr')) addExaminationRow();
    });

    document.getElementById('addExaminationRowBtn').addEventListener('click', addExaminationRow);

    if (!document.querySelector('#examinationTbody tr')) { addExaminationRow(); }
    // 저장 버튼 이벤트
    document.getElementById('saveExamBtn').addEventListener('click', async () => {
        if (!currentVisitId) {
            alert("먼저 환자의 진료 기록을 로드하세요.");
            return;
        }
        const rows = document.querySelectorAll('#examinationTbody tr');
        if (rows.length === 0) {
            alert("추가된 검사 결과가 없습니다.");
            return;
        }

        const form = new FormData();
        form.append('visitId', currentVisitId);

        rows.forEach((row, idx) => {
            // 검사 일자, 종류, 요약
            form.append(`exams[${idx}].examDate`, row.querySelector('.exam-date').value);
            form.append(`exams[${idx}].examType`, row.querySelector('.exam-type').value);
            form.append(`exams[${idx}].examSummary`, row.querySelector('.exam-summary').value);
            // 파일들: 여러개일 수 있으므로 each
            const files = row.querySelector('.exam-media').files;
            for (let i=0; i<files.length; i++) {
                // 서버는 exams[idx].mediaFiles 로 받을 수 있게
                form.append(`exams[${idx}].mediaFiles`, files[i]);
            }
        });

        try {
            const res = await fetch('/examination/save', {
                method: 'POST',
                body: form
            });
            const json = await res.json();
            if (json.success) {
                alert("검사 결과가 저장되었습니다.");
                // 필요 시 리스트 초기화 혹은 재로딩
                document.getElementById('examinationTbody').innerHTML = '';
            } else {
                throw new Error(json.message);
            }
        } catch (e) {
            console.error(e);
            alert("검사 저장 중 오류: " + e.message);
        }
    });

</script>
<script>
    // 전역에 선언된 변수
    var currentVisitId = null;
    var currentPatientId = null;

    async function pollCurrentPatient() {
        try {
            const res = await fetch('/medicalvisit/currentPatient');
            const data = await res.json();
            // 새 visitId 가 넘어오면
            if (data.success && data.visitId && data.visitId !== currentVisitId) {
                currentVisitId  = data.visitId;
                currentPatientId = data.patientId;
                // UI 갱신
                loadCurrentConsultationPatient();
            }
        } catch (e) {
            console.error('진료중 환자 폴링 오류', e);
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        loadCurrentConsultationPatient();
        setInterval(pollCurrentPatient, 5000);
    });
</script>
</body>
</html>
